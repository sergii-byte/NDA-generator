<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash NDA Generator | SBLC Business Lawyers</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F9F6F1;
            --bg-warm: #F4F0E8;
            --card: #FFFFFF;
            --card-hover: #FDFCFA;
            --border: #E5E0D5;
            --border-light: #EDE9E0;
            --text: #2B2926;
            --text-secondary: #6B6560;
            --text-muted: #9A9490;
            --accent: #D97757;
            --accent-hover: #C5684A;
            --accent-soft: rgba(217, 119, 87, 0.08);
            --accent-ring: rgba(217, 119, 87, 0.2);
            --green: #3D9A5F;
            --green-soft: rgba(61, 154, 95, 0.1);
            --yellow-soft: rgba(217, 176, 87, 0.15);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.08);
            --radius: 12px;
            --radius-lg: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ─── Header ─── */
        header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .logo-area h1 {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.35rem;
            font-weight: 400;
            letter-spacing: -0.01em;
            color: var(--text);
        }
        .logo-area p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .logo-area a { text-decoration: none; color: inherit; }
        header img { height: 22px; opacity: 0.7; transition: opacity 0.2s; }
        header img:hover { opacity: 1; }

        /* ─── Main ─── */
        main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 28px 24px 60px;
        }

        /* ─── Stepper ─── */
        .stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        .step-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            border-radius: 100px;
            font-size: 0.82rem;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: default;
        }
        .step-badge.active {
            background: var(--accent);
            color: white;
        }
        .step-badge.done {
            background: var(--green-soft);
            color: var(--green);
        }
        .step-badge.inactive {
            background: var(--bg-warm);
            color: var(--text-muted);
            border: 1px solid var(--border-light);
        }
        .step-num {
            width: 22px; height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }
        .step-badge.active .step-num { background: rgba(255,255,255,0.25); color: white; }
        .step-badge.done .step-num { background: var(--green); color: white; }
        .step-badge.inactive .step-num { background: var(--border); color: var(--text-muted); }
        .step-arrow { color: var(--border); font-size: 1rem; }
        @media (max-width: 640px) { .step-label { display: none; } }

        /* ─── Cards ─── */
        .card {
            background: var(--card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }
        .card + .card { margin-top: 16px; }
        /* ─── Side-by-side Party Cards ─── */
        .parties-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }
        .parties-row .card { margin-top: 0; }
        .parties-row .card .form-row {
            grid-template-columns: 1fr;
        }
        .parties-row .fill-tabs {
            flex-wrap: wrap;
            gap: 4px;
        }
        .parties-row .fill-tab {
            font-size: 0.7rem;
            padding: 5px 6px;
            gap: 3px;
        }
        .parties-row .fill-tab svg { width: 12px; height: 12px; }
        @media (max-width: 860px) {
            .parties-row { grid-template-columns: 1fr; }
            .parties-row .card .form-row { grid-template-columns: 1fr 1fr; }
            .parties-row .fill-tab { font-size: 0.75rem; padding: 6px 10px; gap: 5px; }
            .parties-row .fill-tab svg { width: 14px; height: 14px; }
        }
        @media (max-width: 640px) {
            .parties-row .card .form-row { grid-template-columns: 1fr; }
        }
        .card-title {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.15rem;
            font-weight: 400;
            color: var(--text);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title .badge {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--accent-soft);
            color: var(--accent);
        }

        /* ─── Info Banner ─── */
        .info-banner {
            background: var(--bg-warm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 14px 18px;
            margin-bottom: 16px;
            font-size: 0.88rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .info-banner strong { color: var(--text); }

        /* ─── Form Elements ─── */
        .form-group { margin-bottom: 14px; }
        .form-group:last-child { margin-bottom: 0; }
        label {
            display: block;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--text);
            background: var(--card);
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        input::placeholder, textarea::placeholder { color: var(--text-muted); }
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-ring);
        }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239A9490' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
            cursor: pointer;
        }
        textarea { resize: vertical; min-height: 80px; }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        @media (max-width: 640px) { .form-row { grid-template-columns: 1fr; } }

        /* ─── Autofill Tabs ─── */
        .fill-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .fill-tab {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .fill-tab:hover { background: var(--bg-warm); border-color: var(--accent); color: var(--accent); }
        .fill-tab.active { background: var(--accent); border-color: var(--accent); color: white; }
        .fill-tab svg { width: 14px; height: 14px; }

        /* ─── Autocomplete ─── */
        .autocomplete-wrap { position: relative; }
        .autocomplete-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0; right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-height: 280px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: var(--shadow-lg);
        }
        .autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s;
        }
        .autocomplete-item:hover { background: var(--bg-warm); }
        .autocomplete-item:last-child { border-bottom: none; }
        .ac-name { font-weight: 600; font-size: 0.88rem; color: var(--text); }
        .ac-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }
        .ac-tag {
            font-size: 0.7rem;
            padding: 2px 7px;
            border-radius: 4px;
            font-weight: 500;
        }
        .ac-tag.code { background: var(--bg-warm); color: var(--text-secondary); font-family: 'SF Mono', 'Fira Code', monospace; }
        .ac-tag.jurisdiction { background: #EEF2FF; color: #4F46E5; }
        .ac-tag.status { background: var(--green-soft); color: var(--green); }
        .ac-tag.address-ok { background: var(--green-soft); color: var(--green); }
        .ac-tag.address-missing { background: var(--yellow-soft); color: #B8860B; }
        .ac-tag.source { background: #FFF7ED; color: #C2410C; font-size: 0.65rem; }
        .ac-address { font-size: 0.78rem; color: var(--text-muted); margin-top: 3px; }
        .ac-loading {
            padding: 16px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .ac-loading .spinner {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ─── Checkboxes ─── */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        @media (max-width: 640px) { .checkbox-grid { grid-template-columns: 1fr; } }
        .checkbox-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }
        .checkbox-card:hover { border-color: var(--accent); background: var(--accent-soft); }
        .checkbox-card input[type="checkbox"] {
            width: 16px;
            height: 16px;
            min-width: 16px;
            margin: 0;
            accent-color: var(--accent);
            cursor: pointer;
            flex-shrink: 0;
        }
        .checkbox-card span {
            line-height: 1.3;
        }
        .checkbox-card input:checked + span { color: var(--text); font-weight: 500; }

        /* ─── Buttons ─── */
        .btn-primary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--accent);
            color: white;
        }
        .btn-primary:hover { background: var(--accent-hover); box-shadow: 0 2px 12px var(--accent-ring); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--card);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover { background: var(--bg-warm); border-color: var(--accent); color: var(--accent); }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.88rem;
            color: var(--text-muted);
            cursor: pointer;
            background: none;
            border: none;
            font-family: 'DM Sans', sans-serif;
            transition: color 0.2s;
            margin-bottom: 16px;
        }
        .btn-back:hover { color: var(--accent); }

        /* ─── NDA Output Styling ─── */
        .nda-output-wrap {
            background: var(--card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }
        .nda-output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }
        .nda-output-header h3 {
            font-family: 'Instrument Serif', Georgia, serif;
            font-weight: 400;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nda-output-actions {
            display: flex;
            gap: 8px;
        }

        /* ─── Generated NDA Document ─── */
        .generated-nda {
            background: #FFFEFA;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 40px 48px;
            max-height: 600px;
            overflow-y: auto;
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 0.92rem;
            line-height: 1.85;
            color: #1A1A1A;
        }
        .generated-nda::-webkit-scrollbar { width: 6px; }
        .generated-nda::-webkit-scrollbar-track { background: transparent; }
        .generated-nda::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .generated-nda::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .generated-nda h1 {
            font-family: Georgia, serif;
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin: 0 0 1.2em 0;
            padding-bottom: 0.8em;
            border-bottom: 2px solid #1A1A1A;
        }
        .generated-nda h2 {
            font-family: Georgia, serif;
            font-size: 1.05rem;
            font-weight: bold;
            margin: 1.8em 0 0.6em 0;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .generated-nda h3 {
            font-family: Georgia, serif;
            font-size: 0.95rem;
            font-weight: bold;
            margin: 1.4em 0 0.5em 0;
        }
        .generated-nda p {
            margin: 0 0 0.9em 0;
            text-align: justify;
            hyphens: auto;
        }
        .generated-nda strong { font-weight: bold; }
        .generated-nda em { font-style: italic; }
        .generated-nda ul, .generated-nda ol {
            margin: 0.6em 0 0.9em 1.8em;
        }
        .generated-nda li {
            margin-bottom: 0.4em;
            text-align: justify;
        }
        .generated-nda hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2em 0;
        }
        .generated-nda table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5em 0;
        }
        .generated-nda th, .generated-nda td {
            padding: 10px 16px;
            border: 1px solid var(--border);
            text-align: left;
            vertical-align: top;
        }
        @media (max-width: 640px) {
            .generated-nda { padding: 24px 20px; font-size: 0.85rem; }
        }

        /* ─── Summary Output ─── */
        .summary-content {
            background: #FFFEFA;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 28px 32px;
            max-height: 500px;
            overflow-y: auto;
            font-size: 0.92rem;
            line-height: 1.75;
            color: var(--text);
        }
        .summary-content h1, .summary-content h2, .summary-content h3 {
            font-family: 'Instrument Serif', Georgia, serif;
            font-weight: 400;
            margin: 1.2em 0 0.5em 0;
        }
        .summary-content h1 { font-size: 1.3rem; }
        .summary-content h2 { font-size: 1.1rem; }
        .summary-content p { margin-bottom: 0.8em; }
        .summary-content ul, .summary-content ol { margin: 0.5em 0 0.8em 1.5em; }
        .summary-content li { margin-bottom: 0.3em; }

        /* ─── Loading ─── */
        .loading-state {
            padding: 40px;
            text-align: center;
        }
        .loading-spinner {
            width: 36px; height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin: 0 auto 14px;
        }
        .loading-text { color: var(--text-secondary); font-size: 0.9rem; }

        /* ─── Footer ─── */
        footer {
            border-top: 1px solid var(--border);
            background: var(--card);
            margin-top: 48px;
        }
        .footer-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        footer p, footer a { font-size: 0.8rem; color: var(--text-muted); }
        footer a { text-decoration: none; transition: color 0.2s; }
        footer a:hover { color: var(--accent); }

        /* ─── CTA Footer ─── */
        .cta-banner {
            background: linear-gradient(135deg, var(--accent-soft), #FFF7ED);
            border: 1px solid var(--accent-ring);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 24px;
            text-align: center;
        }
        .cta-banner h4 {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 8px;
        }
        .cta-banner p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 14px; }
        .cta-links { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .cta-links a {
            padding: 8px 20px;
            border-radius: 10px;
            font-size: 0.82rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }
        .cta-links .cta-primary { background: var(--accent); color: white; }
        .cta-links .cta-primary:hover { background: var(--accent-hover); }
        .cta-links .cta-secondary { background: var(--card); border: 1px solid var(--border); color: var(--text-secondary); }
        .cta-links .cta-secondary:hover { border-color: var(--accent); color: var(--accent); }

        .hidden { display: none !important; }
        .space-y > * + * { margin-top: 16px; }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-inner">
            <div class="logo-area">
                <a href="https://sblc.com.ua" target="_blank">
                    <h1>Flash NDA Generator</h1>
                    <p>Generate enforceable NDAs in 30 seconds</p>
                </a>
            </div>
            <a href="https://sblc.com.ua" target="_blank">
                <img src="https://framerusercontent.com/images/LkOVePWb0KiTp4xC1AZiukuRY9M.svg" alt="SBLC Law Firm">
            </a>
        </div>
    </header>

    <main>
        <!-- Stepper -->
        <div class="stepper">
            <div id="step1-badge" class="step-badge active">
                <span class="step-num">1</span>
                <span class="step-label">Flash NDA</span>
            </div>
            <span class="step-arrow">›</span>
            <div id="step2-badge" class="step-badge inactive">
                <span class="step-num">+</span>
                <span class="step-label">Enhanced</span>
            </div>
            <span class="step-arrow">›</span>
            <div id="step3-badge" class="step-badge inactive">
                <span class="step-num">+</span>
                <span class="step-label">Summary</span>
            </div>
            <span class="step-arrow">›</span>
            <div id="step4-badge" class="step-badge inactive">
                <span class="step-num">+</span>
                <span class="step-label">Send</span>
            </div>
        </div>

        <!-- ═══════ STEP 1: Flash NDA ═══════ -->
        <div id="step1" class="space-y">
            <div class="parties-row">
            <!-- Party A -->
            <div class="card">
                <div class="card-title">
                    Disclosing Party
                    <span class="badge">Party A</span>
                </div>

                <div class="fill-tabs" id="fillTabsA">
                    <button class="fill-tab active" onclick="setFillMode('A','search',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Search
                    </button>
                    <button class="fill-tab" onclick="setFillMode('A','website',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        Website
                    </button>
                    <button class="fill-tab" onclick="setFillMode('A','email',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        Email
                    </button>
                    <button class="fill-tab" onclick="setFillMode('A','card',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                        Card
                    </button>
                    <button class="fill-tab" onclick="setFillMode('A','history',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        History
                    </button>
                </div>

                <!-- Search Mode -->
                <div id="fillA-search" class="fill-content">
                    <div class="form-group autocomplete-wrap">
                        <label>Search company register</label>
                        <input type="text" id="searchA" autocomplete="off" placeholder="Type company name..." oninput="searchCompany('A', this.value)">
                        <div id="dropdownA" class="autocomplete-dropdown hidden"></div>
                    </div>
                </div>
                <!-- Website Mode -->
                <div id="fillA-website" class="fill-content hidden">
                    <div class="form-group" style="display:flex;gap:8px;">
                        <input type="url" id="websiteA" placeholder="https://company.com" style="flex:1;">
                        <button class="btn-secondary" onclick="parseWebsite('A')">Fetch</button>
                    </div>
                </div>
                <!-- Email Mode -->
                <div id="fillA-email" class="fill-content hidden">
                    <div class="form-group" style="display:flex;gap:8px;">
                        <input type="email" id="emailFillA" placeholder="contact@company.com" style="flex:1;">
                        <button class="btn-secondary" onclick="parseEmail('A')">Fetch</button>
                    </div>
                </div>
                <!-- Card Mode -->
                <div id="fillA-card" class="fill-content hidden">
                    <div class="form-group" style="display:flex;gap:8px;">
                        <input type="file" id="cardA" accept="image/*" style="flex:1;">
                        <button class="btn-secondary" onclick="parseCard('A')">Scan</button>
                    </div>
                </div>
                <!-- History Mode -->
                <div id="fillA-history" class="fill-content hidden">
                    <div class="form-group">
                        <label>Load from history</label>
                        <select id="historyA" onchange="loadFromHistory('A', this.value)">
                            <option value="">Select previous entry...</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:14px;">
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>Company Name *</label>
                            <input type="text" id="partyAName" autocomplete="off" placeholder="Full legal name">
                            <input type="hidden" id="partyAType" value="Company">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Company Number</label>
                            <input type="text" id="partyACompanyNumber" autocomplete="off" placeholder="Registration number">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="partyAEmail" autocomplete="off" placeholder="contact@company.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Registered Address *</label>
                        <input type="text" id="partyAAddress" autocomplete="off" placeholder="Full registered address">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Signatory Name</label>
                            <input type="text" id="partyASignatory" autocomplete="off" placeholder="Full name of signatory">
                        </div>
                        <div class="form-group">
                            <label>Signatory Title</label>
                            <input type="text" id="partyATitle" autocomplete="off" placeholder="e.g. CEO, Director, Managing Partner">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Party B -->
            <div class="card">
                <div class="card-title">
                    Receiving Party
                    <span class="badge">Party B</span>
                </div>

                <div class="fill-tabs" id="fillTabsB">
                    <button class="fill-tab active" onclick="setFillMode('B','search',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        Search
                    </button>
                    <button class="fill-tab" onclick="setFillMode('B','website',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        Website
                    </button>
                    <button class="fill-tab" onclick="setFillMode('B','email',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        Email
                    </button>
                    <button class="fill-tab" onclick="setFillMode('B','card',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                        Card
                    </button>
                    <button class="fill-tab" onclick="setFillMode('B','history',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        History
                    </button>
                </div>

                <div id="fillB-search" class="fill-content">
                    <div class="form-group autocomplete-wrap">
                        <label>Search company register</label>
                        <input type="text" id="searchB" autocomplete="off" placeholder="Type company name..." oninput="searchCompany('B', this.value)">
                        <div id="dropdownB" class="autocomplete-dropdown hidden"></div>
                    </div>
                </div>
                <div id="fillB-website" class="fill-content hidden">
                    <div class="form-group" style="display:flex;gap:8px;">
                        <input type="url" id="websiteB" placeholder="https://company.com" style="flex:1;">
                        <button class="btn-secondary" onclick="parseWebsite('B')">Fetch</button>
                    </div>
                </div>
                <div id="fillB-email" class="fill-content hidden">
                    <div class="form-group" style="display:flex;gap:8px;">
                        <input type="email" id="emailFillB" placeholder="contact@company.com" style="flex:1;">
                        <button class="btn-secondary" onclick="parseEmail('B')">Fetch</button>
                    </div>
                </div>
                <div id="fillB-card" class="fill-content hidden">
                    <div class="form-group" style="display:flex;gap:8px;">
                        <input type="file" id="cardB" accept="image/*" style="flex:1;">
                        <button class="btn-secondary" onclick="parseCard('B')">Scan</button>
                    </div>
                </div>
                <div id="fillB-history" class="fill-content hidden">
                    <div class="form-group">
                        <label>Load from history</label>
                        <select id="historyB" onchange="loadFromHistory('B', this.value)">
                            <option value="">Select previous entry...</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:14px;">
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>Company Name *</label>
                            <input type="text" id="partyBName" autocomplete="off" placeholder="Full legal name">
                            <input type="hidden" id="partyBType" value="Company">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Company Number</label>
                            <input type="text" id="partyBCompanyNumber" autocomplete="off" placeholder="Registration number">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="partyBEmail" autocomplete="off" placeholder="contact@company.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Registered Address *</label>
                        <input type="text" id="partyBAddress" autocomplete="off" placeholder="Full registered address">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Signatory Name</label>
                            <input type="text" id="partyBSignatory" autocomplete="off" placeholder="Full name of signatory">
                        </div>
                        <div class="form-group">
                            <label>Signatory Title</label>
                            <input type="text" id="partyBTitle" autocomplete="off" placeholder="e.g. CEO, Director, Managing Partner">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Counterparty Role</label>
                        <select id="partyBRole">
                            <option value="Contractor">Contractor</option>
                            <option value="Investor">Investor</option>
                            <option value="Partner">Partner</option>
                            <option value="Employee">Employee</option>
                            <option value="Vendor">Vendor</option>
                        </select>
                    </div>
                </div>
            </div>
            </div><!-- end parties-row -->

            <!-- NDA Terms -->
            <div class="card">
                <div class="card-title">Agreement Terms</div>

                <div class="form-group">
                    <label>Purpose of Disclosure</label>
                    <select id="purposeSelect" onchange="toggleCustomPurpose()">
                        <option value="To evaluate and pursue a potential business collaboration between the Parties.">Business collaboration</option>
                        <option value="To evaluate a potential investment opportunity, including the review of financial, operational, and corporate information.">Investment / Due diligence</option>
                        <option value="To explore and negotiate a potential merger, acquisition, or sale of business assets between the Parties.">M&A / Acquisition</option>
                        <option value="To discuss and negotiate the terms of a potential software development or technology services engagement.">Software / Tech services</option>
                        <option value="To evaluate and negotiate the provision of consulting, advisory, or professional services.">Consulting / Advisory</option>
                        <option value="To evaluate and negotiate a potential vendor, supplier, or outsourcing engagement.">Vendor / Supplier</option>
                        <option value="To engage an independent contractor for the provision of services requiring access to confidential business information.">Contractor engagement</option>
                        <option value="To discuss and evaluate a potential joint venture, strategic alliance, or co-development arrangement.">Joint venture / Partnership</option>
                        <option value="To evaluate and negotiate a potential technology licensing, white-label, or reseller arrangement.">Licensing / White-label</option>
                        <option value="custom">Custom (write your own)...</option>
                    </select>
                    <textarea id="purposeCustom" class="hidden" style="margin-top:8px;" placeholder="Describe the purpose of disclosure..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>NDA Type</label>
                        <select id="ndaType">
                            <option value="Mutual">Mutual (both parties)</option>
                            <option value="Unilateral">Unilateral (one-way)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Effective Date</label>
                        <input type="date" id="agreementDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Confidentiality Period</label>
                        <select id="confPeriod">
                            <option value="1">1 year</option>
                            <option value="2" selected>2 years</option>
                            <option value="3">3 years</option>
                            <option value="5">5 years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Extend obligations to staff?</label>
                        <select id="bindOthers">
                            <option value="Yes">Yes — bind employees, contractors, advisors</option>
                            <option value="No">No — directors and officers only</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Governing Law</label>
                    <select id="governingLaw" onchange="toggleCustomGoverningLaw()">
                        <option value="partyA">Party A jurisdiction (default)</option>
                    </select>
                    <input type="text" id="governingLawCustom" class="hidden" style="margin-top:8px;" placeholder="e.g. Laws of the Republic of Singapore" />
                </div>

                <div class="form-group">
                    <label>Confidential Information Includes</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="business plans and strategies" checked> <span>Business plans & strategies</span></label>
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="financial information" checked> <span>Financial information</span></label>
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="technical data and trade secrets" checked> <span>Technical data & trade secrets</span></label>
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="customer and supplier lists"> <span>Customer & supplier lists</span></label>
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="source code and algorithms"> <span>Source code & algorithms</span></label>
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="marketing and sales data"> <span>Marketing & sales data</span></label>
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="intellectual property"> <span>Intellectual property</span></label>
                        <label class="checkbox-card"><input type="checkbox" class="confInfo" value="personnel information"> <span>Personnel information</span></label>
                    </div>
                </div>
            </div>

            <!-- Generate -->
            <button class="btn-primary" onclick="generateNDA()" id="generateBtn1">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                Generate Flash NDA
            </button>

            <!-- Loading State 1 -->
            <div id="loadingState1" class="card hidden">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Drafting your NDA...</div>
                </div>
            </div>

            <!-- Result 1 -->
            <div id="result1" class="hidden">
                <div class="nda-output-wrap">
                    <div class="nda-output-header">
                        <h3><span style="color:var(--green)">✓</span> Flash NDA Ready</h3>
                        <div class="nda-output-actions">
                            <button class="btn-secondary" onclick="copyText(generatedNDAText)">Copy</button>
                            <button class="btn-secondary" onclick="downloadPDF('ndaContent1', 'NDA.pdf')">PDF</button>
                        </div>
                    </div>
                    <div id="ndaContent1" class="generated-nda"></div>
                </div>

                <div style="display:flex;gap:12px;margin-top:16px;">
                    <button class="btn-primary" style="flex:1;" onclick="goToStep2()">
                        Add Enhanced Protections →
                    </button>
                    <button class="btn-secondary" onclick="goToStep3()" style="padding:14px 20px;">
                        Skip to Summary
                    </button>
                </div>
            </div>
        </div>

        <!-- ═══════ STEP 2: Enhanced ═══════ -->
        <div id="step2" class="hidden space-y">
            <button class="btn-back" onclick="backToStep1()">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
                Back to Flash NDA
            </button>

            <div class="info-banner">
                <strong>Step 2:</strong> Add advanced protections — compensation for breach, non-solicitation, non-compete, arbitration, and more.
            </div>

            <div class="card">
                <div class="card-title">Enhanced Protections</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Residual Knowledge</label>
                        <select id="residualKnowledge">
                            <option value="Permitted">Permitted (standard)</option>
                            <option value="Restricted">Restricted (strict)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Return Materials Within</label>
                        <select id="returnDays">
                            <option value="10">10 days</option>
                            <option value="14" selected>14 days</option>
                            <option value="30">30 days</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Written Certification of Destruction</label>
                        <select id="writtenCert">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Restrict Professional Advisors</label>
                        <select id="restrictAdvisors">
                            <option value="No">No — permitted (default from NDA)</option>
                            <option value="Yes">Yes — require prior written consent</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Prohibit Public LLM / AI Uploads</label>
                        <select id="prohibitLLM">
                            <option value="Yes">Yes — prohibit</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notify Before Legal Disclosure</label>
                        <select id="notifyCompelled">
                            <option value="Yes">Yes (unless prohibited by court order)</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>

                <div style="border-top:1px solid var(--border-light);margin:16px 0 12px;"></div>
                <div class="card-title" style="font-size:0.85rem;">Non-Solicitation</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Non-Solicitation</label>
                        <select id="prohibitSoliciting" onchange="toggleSolicitFields()">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group" id="solicitScopeGroup" style="display:none;">
                        <label>Scope</label>
                        <select id="solicitScope">
                            <option value="Employees">Employees only</option>
                            <option value="Employees+Contractors" selected>Employees + Contractors</option>
                            <option value="All+Clients">Employees + Contractors + Clients</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="solicitRow2" style="display:none;">
                    <div class="form-group">
                        <label>Non-Solicitation Duration</label>
                        <select id="solicitDuration">
                            <option value="12">12 months</option>
                            <option value="18">18 months</option>
                            <option value="24" selected>24 months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Carve-out for Public Job Postings</label>
                        <select id="solicitCarveout">
                            <option value="Yes">Yes — general ads excluded</option>
                            <option value="No">No — all solicitation prohibited</option>
                        </select>
                    </div>
                </div>

                <div style="border-top:1px solid var(--border-light);margin:16px 0 12px;"></div>
                <div class="card-title" style="font-size:0.85rem;">Non-Compete (use sparingly)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Non-Compete</label>
                        <select id="nonCompete" onchange="toggleCompeteFields()">
                            <option value="No">No (recommended for NDA)</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group" id="competeDurationGroup" style="display:none;">
                        <label>Duration</label>
                        <select id="competeDuration">
                            <option value="6">6 months</option>
                            <option value="12" selected>12 months</option>
                            <option value="24">24 months</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="competeRow2" style="display:none;">
                    <div class="form-group">
                        <label>Geographic Scope</label>
                        <input type="text" id="competeGeo" placeholder="e.g. European Union, worldwide">
                    </div>
                    <div class="form-group">
                        <label>Industry / Activity Scope</label>
                        <input type="text" id="competeScope" placeholder="e.g. fintech payment processing">
                    </div>
                </div>

                <div style="border-top:1px solid var(--border-light);margin:16px 0 12px;"></div>
                <div class="card-title" style="font-size:0.85rem;">Compensation for Breach</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Remedy Type</label>
                        <select id="breachRemedy" onchange="toggleBreachFields()">
                            <option value="Damages">Actual Damages Only (default)</option>
                            <option value="Liquidated">Liquidated Damages (common law)</option>
                            <option value="Penalty">Contractual Penalty (civil law only)</option>
                        </select>
                    </div>
                    <div class="form-group" id="breachAmountGroup" style="display:none;">
                        <label id="breachAmountLabel">Amount</label>
                        <div style="display:flex;gap:8px;">
                            <select id="breachCurrency" style="flex:0 0 90px;" onchange="toggleBreachCurrency()">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="CHF">CHF</option>
                                <option value="AED">AED</option>
                                <option value="PLN">PLN</option>
                                <option value="CZK">CZK</option>
                                <option value="custom">Other</option>
                            </select>
                            <input type="text" id="breachCurrencyCustom" class="hidden" style="flex:0 0 70px;" placeholder="e.g. SGD">
                            <input type="text" id="breachAmount" style="flex:1;" placeholder="e.g. 50,000">
                        </div>
                    </div>
                </div>
                <div id="breachWarning" class="hidden" style="font-size:0.78rem;color:var(--accent);padding:4px 0 8px;">
                    ⚠ Penalty clauses are unenforceable in common law jurisdictions (UK, USA, Singapore, Hong Kong, Australia). Use liquidated damages instead.
                </div>

                <div style="border-top:1px solid var(--border-light);margin:16px 0 12px;"></div>
                <div class="card-title" style="font-size:0.85rem;">Dispute Resolution</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Dispute Resolution Method</label>
                        <select id="disputeMethod" onchange="toggleArbFields()">
                            <option value="Courts">Courts (default)</option>
                            <option value="Arbitration">Arbitration</option>
                            <option value="Mediation then Arbitration">Mediation then Arbitration</option>
                        </select>
                    </div>
                </div>
                <div id="arbFields" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Arbitration Institution</label>
                            <select id="arbRules" onchange="onArbInstitutionChange()">
                                <option value="ICC">ICC — International Chamber of Commerce</option>
                                <option value="LCIA">LCIA — London Court of International Arbitration</option>
                                <option value="AAA_ICDR">AAA/ICDR — International Centre for Dispute Resolution</option>
                                <option value="SIAC">SIAC — Singapore International Arbitration Centre</option>
                                <option value="SCC">SCC — Stockholm Chamber of Commerce</option>
                                <option value="DIAC">DIAC — Dubai International Arbitration Centre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Seat of Arbitration</label>
                            <input type="text" id="arbLocation" placeholder="Auto-filled or enter manually">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Number of Arbitrators</label>
                            <select id="arbCount" onchange="updateArbClausePreview()">
                                <option value="1" selected>Sole arbitrator (default)</option>
                                <option value="3">Three arbitrators</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Arbitration Language</label>
                            <select id="arbLanguage">
                                <option value="English">English</option>
                                <option value="French">French</option>
                                <option value="German">German</option>
                                <option value="Spanish">Spanish</option>
                                <option value="Arabic">Arabic</option>
                                <option value="Russian">Russian</option>
                            </select>
                        </div>
                    </div>
                    <div id="arbClausePreview" style="margin-top: 10px; padding: 14px 16px; background: var(--bg-alt); border: 1px solid var(--border-light); border-radius: 10px; font-size: 0.8rem; line-height: 1.65; color: var(--text-secondary); font-family: Georgia, 'Times New Roman', serif; display: none;">
                        <div style="font-family: var(--font-body); font-size: 0.7rem; font-weight: 600; color: var(--accent); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px;">Model Clause Preview</div>
                        <div id="arbClauseText"></div>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="generateEnhancedNDA()" id="generateBtn2">
                Generate Enhanced NDA
            </button>

            <div id="loadingState2" class="card hidden">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Enhancing your NDA with additional protections...</div>
                </div>
            </div>

            <div id="result2" class="hidden">
                <div class="nda-output-wrap">
                    <div class="nda-output-header">
                        <h3><span style="color:var(--green)">✓</span> Enhanced NDA Ready</h3>
                        <div class="nda-output-actions">
                            <button class="btn-secondary" onclick="copyText(generatedNDAText2)">Copy</button>
                            <button class="btn-secondary" onclick="downloadPDF('ndaContent2', 'NDA_Enhanced.pdf')">PDF</button>
                        </div>
                    </div>
                    <div id="ndaContent2" class="generated-nda"></div>
                </div>

                <button class="btn-primary" style="margin-top:16px;" onclick="goToStep3()">
                    Generate Plain-English Summary →
                </button>
            </div>
        </div>

        <!-- ═══════ STEP 3: Summary ═══════ -->
        <div id="step3" class="hidden space-y">
            <button class="btn-back" onclick="backToResults()">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
                Back
            </button>

            <div class="info-banner">
                <strong>Step 3:</strong> Generate a friendly summary to share with the counterparty. They'll understand the key terms without legal jargon.
            </div>

            <div class="card">
                <p style="color:var(--text-secondary);margin-bottom:14px;">
                    This will explain the <strong id="summarySource">Flash NDA</strong> in simple terms for the other party.
                </p>
                <button class="btn-primary" onclick="generateSummary()" id="generateBtn3">
                    Generate Plain-English Summary
                </button>
            </div>

            <div id="loadingState3" class="card hidden">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Creating plain-English summary...</div>
                </div>
            </div>

            <div id="result3" class="hidden">
                <div class="nda-output-wrap">
                    <div class="nda-output-header">
                        <h3><span style="color:var(--green)">✓</span> Summary Ready</h3>
                        <div class="nda-output-actions">
                            <button class="btn-secondary" onclick="copyText(generatedSummaryText)">Copy</button>
                            <button class="btn-secondary" onclick="downloadPDF('summaryContent', 'NDA_Summary.pdf')">PDF</button>
                        </div>
                    </div>
                    <div id="summaryContent" class="summary-content"></div>
                </div>

                <div class="cta-banner">
                    <h4>🎉 Your NDA package is complete</h4>
                    <p>Need a polished Word document or want a lawyer to review your NDA?</p>
                    <div class="cta-links">
                        <a href="mailto:hello@sblc.com.ua?subject=Flash%20NDA%20—%20Word%20Document%20Request" class="cta-primary">Word Document — $10</a>
                        <a href="mailto:hello@sblc.com.ua?subject=Flash%20NDA%20—%20Legal%20Audit%20Request" class="cta-secondary">Legal Audit — $100</a>
                    </div>
                </div>

                <button class="btn-primary" style="margin-top:16px;" onclick="goToStep4()">
                    Compose Cover Email →
                </button>
                <button class="btn-secondary" style="margin-top:8px;" onclick="backToStep1()">
                    ← Create Another NDA
                </button>
            </div>
        </div>

        <!-- ═══════ STEP 4: Cover Email ═══════ -->
        <div id="step4" class="hidden space-y">
            <button class="btn-back" onclick="backToStep3()">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
                Back
            </button>

            <div class="info-banner">
                <strong>Step 4:</strong> Copy this cover email to send your NDA professionally. All fields are pre-filled from your form.
            </div>

            <div class="card">
                <div class="card-title">Cover Email</div>
                <div style="margin-bottom:12px;">
                    <label style="font-size:0.78rem;color:var(--text-muted);font-weight:600;">Subject</label>
                    <input type="text" id="emailSubject" style="margin-top:4px;" />
                </div>
                <div>
                    <label style="font-size:0.78rem;color:var(--text-muted);font-weight:600;">Email Body</label>
                    <textarea id="emailBody" style="margin-top:4px;min-height:280px;line-height:1.7;font-family:var(--font-body);"></textarea>
                </div>
                <div style="display:flex;gap:8px;margin-top:12px;">
                    <button class="btn-primary" onclick="copyEmailText()" style="flex:1;">
                        Copy Email
                    </button>
                    <button class="btn-secondary" onclick="openInMailClient()" style="flex:0 0 auto;">
                        Open in Mail
                    </button>
                </div>
                <div id="emailCopied" class="hidden" style="text-align:center;padding:8px;color:var(--green);font-size:0.85rem;font-weight:600;">
                    ✓ Copied to clipboard
                </div>
            </div>

            <div class="cta-banner">
                <h4>🎉 Your NDA package is complete</h4>
                <p>Need a polished Word document or want a lawyer to review your NDA?</p>
                <div class="cta-links">
                    <a href="mailto:hello@sblc.com.ua?subject=Flash%20NDA%20—%20Word%20Document%20Request" class="cta-primary">Word Document — $10</a>
                    <a href="mailto:hello@sblc.com.ua?subject=Flash%20NDA%20—%20Legal%20Audit%20Request" class="cta-secondary">Legal Audit — $100</a>
                </div>
            </div>

            <button class="btn-secondary" style="margin-top:8px;" onclick="backToStep1()">
                ← Create Another NDA
            </button>
        </div>

        <!-- CTA (hidden until NDA generated) -->
        <div id="footerCTA" class="hidden">
            <div class="cta-banner">
                <h4>Want a polished Word document?</h4>
                <p>Get a professionally formatted .docx ready for signing, or have a lawyer review your NDA.</p>
                <div class="cta-links">
                    <a href="mailto:hello@sblc.com.ua?subject=Flash%20NDA%20—%20Word%20Document%20Request" class="cta-primary">Word Document — $10</a>
                    <a href="mailto:hello@sblc.com.ua?subject=Flash%20NDA%20—%20Legal%20Audit%20Request" class="cta-secondary">Legal Audit — $100</a>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-inner">
            <p>© 2025 SBLC Law Firm. All rights reserved.</p>
            <div style="display:flex;gap:16px;">
                <a href="mailto:hello@sblc.com.ua">hello@sblc.com.ua</a>
                <a href="https://sblc.com.ua" target="_blank">sblc.com.ua</a>
            </div>
        </div>
    </footer>

    <script>
        let generatedNDAText = '';
        let generatedNDAText2 = '';
        let generatedSummaryText = '';
        let searchTimeout = null;

        // ═══════ Save/Load Party Data ═══════
        function savePartyData(party) {
            const data = {
                name: document.getElementById(`party${party}Name`).value,
                type: document.getElementById(`party${party}Type`).value,
                companyNumber: document.getElementById(`party${party}CompanyNumber`).value,
                address: document.getElementById(`party${party}Address`).value,
                email: document.getElementById(`party${party}Email`).value,
                signatory: document.getElementById(`party${party}Signatory`).value,
                title: document.getElementById(`party${party}Title`).value,
            };
            localStorage.setItem(`nda_party${party}`, JSON.stringify(data));
        }
        function loadPartyData(party) {
            const saved = localStorage.getItem(`nda_party${party}`);
            if (saved) {
                const data = JSON.parse(saved);
                if (data.name) document.getElementById(`party${party}Name`).value = data.name;
                if (data.type) document.getElementById(`party${party}Type`).value = data.type;
                if (data.companyNumber) document.getElementById(`party${party}CompanyNumber`).value = data.companyNumber;
                if (data.address) document.getElementById(`party${party}Address`).value = data.address;
                if (data.email) document.getElementById(`party${party}Email`).value = data.email;
                if (data.signatory) document.getElementById(`party${party}Signatory`).value = data.signatory;
                if (data.title) document.getElementById(`party${party}Title`).value = data.title;
            }
        }
        function saveToHistory(party, name, address, email, type, companyNumber, signatory, title) {
            if (!name) return;
            let history = JSON.parse(localStorage.getItem('nda_history') || '[]');
            history = history.filter(h => h.name !== name);
            history.unshift({ party, name, address, email, type, companyNumber, signatory, title, date: new Date().toISOString() });
            history = history.slice(0, 20);
            localStorage.setItem('nda_history', JSON.stringify(history));
            populateHistoryDropdowns();
        }
        function populateHistoryDropdowns() {
            const history = JSON.parse(localStorage.getItem('nda_history') || '[]');
            ['A', 'B'].forEach(party => {
                const sel = document.getElementById(`history${party}`);
                sel.innerHTML = '<option value="">Select previous entry...</option>';
                history.forEach((h, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `${h.name}${h.address ? ' — ' + h.address.substring(0,30) + '...' : ''}`;
                    sel.appendChild(opt);
                });
            });
        }
        function loadFromHistory(party, index) {
            if (index === '') return;
            const history = JSON.parse(localStorage.getItem('nda_history') || '[]');
            const h = history[index];
            if (h) {
                document.getElementById(`party${party}Name`).value = h.name || '';
                document.getElementById(`party${party}Type`).value = h.type || 'Company';
                document.getElementById(`party${party}CompanyNumber`).value = h.companyNumber || '';
                document.getElementById(`party${party}Address`).value = h.address || '';
                document.getElementById(`party${party}Email`).value = h.email || '';
                document.getElementById(`party${party}Signatory`).value = h.signatory || '';
                document.getElementById(`party${party}Title`).value = h.title || '';
            }
        }

        // ═══════ Fill Mode Tabs ═══════
        function toggleCustomPurpose() {
            const sel = document.getElementById('purposeSelect');
            const custom = document.getElementById('purposeCustom');
            if (sel.value === 'custom') {
                custom.classList.remove('hidden');
                custom.focus();
            } else {
                custom.classList.add('hidden');
            }
        }

        function getPurpose() {
            const sel = document.getElementById('purposeSelect');
            if (sel.value === 'custom') {
                return document.getElementById('purposeCustom').value || 'To evaluate and pursue a potential business relationship between the Parties.';
            }
            return sel.value;
        }

        function setFillMode(party, mode, btn) {
            document.querySelectorAll(`#fillTabs${party} .fill-tab`).forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll(`[id^="fill${party}-"]`).forEach(el => el.classList.add('hidden'));
            document.getElementById(`fill${party}-${mode}`).classList.remove('hidden');
        }

        // ═══════ Company Search ═══════
        // Server-side: UK Companies House, Czech ARES, OpenCorporates
        // Manual links: Estonia, Lithuania, Poland (no free server API available)
        const REGISTER_LINKS = [
            { name: 'Estonia 🇪🇪', url: 'https://ariregister.rik.ee/eng/company_search' },
            { name: 'Lithuania 🇱🇹', url: 'https://www.registrucentras.lt/jar/p_en/' },
            { name: 'Poland 🇵🇱', url: 'https://wyszukiwarka-krs.ms.gov.pl/' },
            { name: 'Singapore 🇸🇬', url: 'https://www.acra.gov.sg/how-to-guides/before-you-start/check-company-name' },
            { name: 'USA 🇺🇸', url: 'https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany' },
        ];

        function searchCompany(party, query) {
            const dropdown = document.getElementById(`dropdown${party}`);
            clearTimeout(searchTimeout);
            if (query.length < 2) { dropdown.classList.add('hidden'); return; }

            dropdown.innerHTML = '<div class="ac-loading"><span class="spinner"></span>Searching registers...</div>';
            dropdown.classList.remove('hidden');

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch('/.netlify/functions/search-company', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query })
                    });
                    const data = await safeJson(res);
                    const results = data.results || [];

                    if (results.length > 0) {
                        dropdown.innerHTML = results.map(r => `
                            <div class="autocomplete-item" onclick='selectCompany("${party}", ${JSON.stringify(r).replace(/'/g, "&#39;")})'>
                                <div class="ac-name">${escapeHtml(r.name)}</div>
                                <div class="ac-meta">
                                    ${r.companyNumber ? `<span class="ac-tag code">${escapeHtml(r.companyNumber)}</span>` : ''}
                                    ${r.jurisdiction ? `<span class="ac-tag jurisdiction">${escapeHtml(r.jurisdiction)}</span>` : ''}
                                    ${r.status ? `<span class="ac-tag status">${escapeHtml(r.status)}</span>` : ''}
                                    ${r.address ? '<span class="ac-tag address-ok">Address ✓</span>' : '<span class="ac-tag address-missing">No address</span>'}
                                    <span class="ac-tag source">${escapeHtml(r.source)}</span>
                                </div>
                                ${r.address ? `<div class="ac-address">${escapeHtml(r.address)}</div>` : ''}
                            </div>
                        `).join('');
                    } else {
                        dropdown.innerHTML = '<div class="ac-loading">No results found</div>';
                    }

                    // Always show manual register links at bottom
                    const linksHtml = REGISTER_LINKS.map(r =>
                        `<a href="${r.url}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;font-size:0.8rem;white-space:nowrap;">${r.name}</a>`
                    ).join(' · ');
                    dropdown.innerHTML += `<div style="padding:8px 12px;border-top:1px solid var(--border);font-size:0.78rem;color:var(--text-muted);">Search manually: ${linksHtml}</div>`;

                    if (data.warning) {
                        dropdown.innerHTML += `<div class="ac-loading" style="font-size:0.75rem;color:var(--text-muted);">${escapeHtml(data.warning)}</div>`;
                    }
                } catch (e) {
                    dropdown.innerHTML = '<div class="ac-loading">Search error. Try again.</div>';
                }
            }, 400);
        }

        function selectCompany(party, company) {
            document.getElementById(`party${party}Name`).value = company.name || '';
            document.getElementById(`party${party}CompanyNumber`).value = company.companyNumber || '';
            document.getElementById(`party${party}Address`).value = company.address || '';
            if (company.companyType) {
                const typeMap = {
                    'ltd': 'LTD', 'private-limited-guarant-nsc': 'LTD', 'plc': 'Corporation', 'llp': 'Partnership',
                    'oü': 'LTD', 'as': 'Corporation', 'fie': 'Individual', 'mtü': 'Company', 'sa': 'Company',
                    's.r.o.': 'LTD', 'a.s.': 'Corporation', 'v.o.s.': 'Partnership', 'k.s.': 'Partnership',
                };
                const mapped = typeMap[(company.companyType || '').toLowerCase()];
                if (mapped) document.getElementById(`party${party}Type`).value = mapped;
            }
            document.getElementById(`dropdown${party}`).classList.add('hidden');
            document.getElementById(`search${party}`).value = '';
            updateGoverningLawOptions();
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // ═══════ Website / Email / Card Parsing ═══════
        async function parseWebsite(party) {
            const url = document.getElementById(`website${party}`).value;
            if (!url) return alert('Enter a website URL');
            const btn = event.target;
            btn.textContent = 'Fetching...';
            btn.disabled = true;
            try {
                const res = await fetch('/.netlify/functions/parse-company', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url.startsWith('http') ? url : 'https://' + url })
                });
                const data = await safeJson(res);
                if (!res.ok) throw new Error(data.error || 'Failed to fetch');
                if (data.name) document.getElementById(`party${party}Name`).value = data.name;
                // Backend returns "addresses" array, take the first one
                const addr = data.address || (Array.isArray(data.addresses) && data.addresses[0]) || '';
                if (addr) document.getElementById(`party${party}Address`).value = addr;
                if (data.email) document.getElementById(`party${party}Email`).value = data.email;
                updateGoverningLawOptions();
                if (!data.name && !addr && !data.email) {
                    alert('Could not extract company info from this website. Try the contact page URL directly.');
                }
            } catch (e) { alert('Failed to parse website: ' + e.message); }
            finally { btn.textContent = 'Fetch'; btn.disabled = false; }
        }

        async function parseEmail(party) {
            const email = document.getElementById(`emailFill${party}`).value;
            if (!email || !email.includes('@')) return alert('Enter a valid email');
            const domain = email.split('@')[1];
            document.getElementById(`party${party}Email`).value = email;
            const btn = event.target;
            btn.textContent = 'Fetching...';
            btn.disabled = true;
            try {
                const res = await fetch('/.netlify/functions/parse-company', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: `https://${domain}` })
                });
                const data = await safeJson(res);
                if (data.name) document.getElementById(`party${party}Name`).value = data.name;
                const addr = data.address || (Array.isArray(data.addresses) && data.addresses[0]) || '';
                if (addr) document.getElementById(`party${party}Address`).value = addr;
                updateGoverningLawOptions();
            } catch (e) { /* silently fail */ }
            finally { btn.textContent = 'Fetch'; btn.disabled = false; }
        }

        async function parseCard(party) {
            const file = document.getElementById(`card${party}`).files[0];
            if (!file) return alert('Select an image of a business card');
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    const res = await fetch('/.netlify/functions/parse-card', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: reader.result })
                    });
                    const data = await safeJson(res);
                    // Card returns: { name: "Person", company: "Company", title: "CEO", email, phone, address }
                    if (data.company) document.getElementById(`party${party}Name`).value = data.company;
                    else if (data.name) document.getElementById(`party${party}Name`).value = data.name;
                    if (data.address) document.getElementById(`party${party}Address`).value = data.address;
                    if (data.email) document.getElementById(`party${party}Email`).value = data.email;
                    if (data.name) document.getElementById(`party${party}Signatory`).value = data.name;
                    if (data.title) document.getElementById(`party${party}Title`).value = data.title;
                    updateGoverningLawOptions();
                } catch (e) { alert('Failed to parse card'); }
            };
            reader.readAsDataURL(file);
        }

        // ═══════ Governing Law ═══════
        function getGoverningLaw() {
            const sel = document.getElementById('governingLaw');
            if (sel.value === 'custom') {
                return document.getElementById('governingLawCustom').value.trim();
            }
            if (sel.value === 'partyA' || !sel.value) {
                // Default: detect from Party A address
                const addrA = document.getElementById('partyAAddress').value;
                const jurA = detectJurisdictionFromAddress(addrA);
                if (jurA) return jurA;
                // Fallback: try Party B
                const addrB = document.getElementById('partyBAddress').value;
                const jurB = detectJurisdictionFromAddress(addrB);
                return jurB || '';
            }
            return sel.value;
        }

        function detectJurisdictionFromAddress(address) {
            if (!address) return null;
            const addr = address.toLowerCase();
            const map = {
                // ── UK ──
                'England and Wales': ['england', 'wales', 'london', 'manchester', 'birmingham', 'liverpool', 'leeds', 'bristol', 'nottingham', 'sheffield', 'leicester', 'coventry', 'oxford', 'cambridge', 'southampton', 'newcastle upon tyne', 'brighton'],
                'Scotland': ['scotland', 'edinburgh', 'glasgow', 'aberdeen', 'dundee'],
                'Northern Ireland': ['northern ireland', 'belfast'],
                // ── USA ──
                'Delaware, USA': ['delaware', 'wilmington, de', ', de 19'],
                'State of New York, USA': ['new york', ', ny '],
                'State of California, USA': ['california', 'san francisco', 'los angeles', 'san diego', 'san jose', 'silicon valley', 'palo alto', 'mountain view', ', ca '],
                'State of Texas, USA': ['texas', 'houston', 'austin, tx', 'dallas', 'san antonio', 'fort worth', ', tx '],
                'State of Florida, USA': ['florida', 'miami', 'orlando', 'tampa', 'jacksonville', ', fl '],
                'State of Illinois, USA': ['illinois', 'chicago', ', il '],
                'State of Washington, USA': ['seattle', 'washington state', ', wa 9'],
                'State of Massachusetts, USA': ['massachusetts', 'boston', ', ma 0'],
                'State of Colorado, USA': ['colorado', 'denver', ', co 8'],
                'State of Georgia, USA': ['atlanta', ', ga 3'],
                'State of Wyoming, USA': ['wyoming', 'cheyenne, wy', ', wy 8'],
                'State of Nevada, USA': ['nevada', 'las vegas', 'reno, nv', ', nv 8'],
                // ── Canada ──
                'Province of Ontario, Canada': ['ontario', 'toronto', 'ottawa'],
                'Province of British Columbia, Canada': ['british columbia', 'vancouver'],
                'Province of Quebec, Canada': ['quebec', 'montreal', 'québec'],
                'Province of Alberta, Canada': ['alberta', 'calgary', 'edmonton'],
                // ── EU: Iberia ──
                'Republic of Portugal': ['portugal', 'lisbon', 'lisboa', 'porto', 'braga', 'funchal', 'faro', 'coimbra', 'aveiro'],
                'Kingdom of Spain': ['spain', 'españa', 'madrid', 'barcelona', 'valencia', 'seville', 'sevilla', 'malaga', 'málaga', 'bilbao', 'zaragoza', 'alicante', 'las palmas'],
                // ── EU: Western ──
                'France': ['france', 'paris', 'lyon', 'marseille', 'nice', 'toulouse', 'bordeaux', 'nantes', 'strasbourg', 'lille', 'montpellier'],
                'Kingdom of Belgium': ['belgium', 'belgique', 'brussels', 'bruxelles', 'antwerp', 'antwerpen', 'ghent', 'gent', 'liège'],
                'The Netherlands': ['netherlands', 'nederland', 'amsterdam', 'rotterdam', 'the hague', 'den haag', 'eindhoven', 'utrecht', 'tilburg', 'groningen'],
                'Grand Duchy of Luxembourg': ['luxembourg', 'luxemburg'],
                'Republic of Ireland': ['ireland', 'dublin', 'cork', 'galway', 'limerick', 'waterford'],
                // ── EU: DACH ──
                'Germany': ['germany', 'deutschland', 'berlin', 'munich', 'münchen', 'frankfurt', 'hamburg', 'düsseldorf', 'dusseldorf', 'cologne', 'köln', 'stuttgart', 'dortmund', 'essen', 'leipzig', 'bremen', 'dresden', 'hannover', 'nürnberg', 'nuremberg'],
                'Republic of Austria': ['austria', 'österreich', 'vienna', 'wien', 'salzburg', 'graz', 'innsbruck', 'linz', 'klagenfurt'],
                'Switzerland': ['switzerland', 'schweiz', 'suisse', 'zurich', 'zürich', 'geneva', 'genève', 'bern', 'basel', 'lausanne', 'lucerne', 'luzern', 'lugano'],
                'Principality of Liechtenstein': ['liechtenstein', 'vaduz'],
                // ── EU: Nordics ──
                'Kingdom of Denmark': ['denmark', 'danmark', 'copenhagen', 'københavn', 'aarhus', 'odense'],
                'Kingdom of Sweden': ['sweden', 'sverige', 'stockholm', 'gothenburg', 'göteborg', 'malmö', 'uppsala'],
                'Republic of Finland': ['finland', 'suomi', 'helsinki', 'espoo', 'tampere', 'turku', 'oulu'],
                'Kingdom of Norway': ['norway', 'norge', 'oslo', 'bergen', 'trondheim', 'stavanger'],
                'Republic of Iceland': ['iceland', 'ísland', 'reykjavik', 'reykjavík'],
                // ── EU: Baltics ──
                'Republic of Estonia': ['estonia', 'eesti', 'tallinn', 'tartu', 'pärnu', 'narva'],
                'Republic of Latvia': ['latvia', 'latvija', 'riga', 'daugavpils', 'liepaja', 'liepāja', 'jūrmala'],
                'Republic of Lithuania': ['lithuania', 'lietuva', 'vilnius', 'kaunas', 'klaipeda', 'klaipėda', 'šiauliai'],
                // ── EU: Central ──
                'Republic of Poland': ['poland', 'polska', 'warsaw', 'warszawa', 'kraków', 'krakow', 'wroclaw', 'wrocław', 'gdansk', 'gdańsk', 'poznan', 'poznań', 'łódź', 'lodz', 'katowice', 'lublin', 'szczecin'],
                'Czech Republic': ['czech', 'česko', 'prague', 'praha', 'brno', 'ostrava', 'plzeň', 'plzen', 'olomouc', 'liberec'],
                'Slovak Republic': ['slovakia', 'slovensko', 'bratislava', 'košice', 'kosice', 'prešov', 'žilina', 'nitra'],
                'Hungary': ['hungary', 'magyarország', 'budapest', 'debrecen', 'szeged', 'miskolc', 'pécs'],
                'Republic of Slovenia': ['slovenia', 'slovenija', 'ljubljana', 'maribor'],
                // ── EU: Southeast ──
                'Republic of Italy': ['italy', 'italia', 'rome', 'roma', 'milan', 'milano', 'naples', 'napoli', 'turin', 'torino', 'florence', 'firenze', 'bologna', 'genoa', 'genova', 'palermo', 'venice', 'venezia', 'bari', 'verona'],
                'Republic of Greece': ['greece', 'ελλάδα', 'athens', 'athina', 'thessaloniki', 'patras', 'heraklion', 'larissa'],
                'Republic of Cyprus': ['cyprus', 'κύπρος', 'nicosia', 'limassol', 'larnaca', 'paphos', 'lefkosia', 'lemesos'],
                'Republic of Malta': ['malta', 'valletta', 'sliema', 'st. julian'],
                'Republic of Croatia': ['croatia', 'hrvatska', 'zagreb', 'split', 'dubrovnik', 'rijeka', 'osijek'],
                'Romania': ['romania', 'românia', 'bucharest', 'bucurești', 'cluj', 'timișoara', 'timisoara', 'iași', 'iasi', 'constanța', 'brasov', 'brașov'],
                'Republic of Bulgaria': ['bulgaria', 'българия', 'sofia', 'plovdiv', 'varna', 'burgas'],
                // ── Balkans (non-EU) ──
                'Republic of Serbia': ['serbia', 'srbija', 'belgrade', 'beograd', 'novi sad'],
                'Montenegro': ['montenegro', 'crna gora', 'podgorica', 'budva'],
                'Republic of North Macedonia': ['north macedonia', 'skopje', 'bitola'],
                'Republic of Albania': ['albania', 'tirana', 'tiranë', 'durrës'],
                'Bosnia and Herzegovina': ['bosnia', 'hercegovina', 'sarajevo', 'banja luka'],
                'Republic of Kosovo': ['kosovo', 'pristina', 'prishtina'],
                // ── Eastern Europe / CIS ──
                'Ukraine': ['ukraine', 'україна', 'kyiv', 'kiev', 'kharkiv', 'odesa', 'odessa', 'dnipro', 'lviv'],
                'Republic of Georgia': ['tbilisi', 'batumi', 'kutaisi'],
                'Republic of Moldova': ['moldova', 'chișinău', 'chisinau'],
                'Republic of Armenia': ['armenia', 'yerevan'],
                'Republic of Azerbaijan': ['azerbaijan', 'baku'],
                'Republic of Belarus': ['belarus', 'minsk'],
                'Republic of Turkey': ['turkey', 'türkiye', 'istanbul', 'ankara', 'izmir', 'antalya', 'bursa'],
                'Russian Federation': ['russia', 'москва', 'moscow', 'saint petersburg'],
                // ── Central Asia ──
                'Republic of Kazakhstan': ['kazakhstan', 'almaty', 'astana', 'nur-sultan'],
                'Republic of Uzbekistan': ['uzbekistan', 'tashkent'],
                'Kyrgyz Republic': ['kyrgyzstan', 'bishkek'],
                'Republic of Tajikistan': ['tajikistan', 'dushanbe'],
                'Turkmenistan': ['turkmenistan', 'ashgabat'],
                // ── Middle East ──
                'UAE Federal Law': ['united arab emirates', 'uae', 'emirates', 'sharjah', 'ajman', 'ras al khaimah', 'fujairah', 'umm al quwain'],
                'Emirate of Dubai': ['dubai'],
                'Emirate of Abu Dhabi': ['abu dhabi'],
                'DIFC Law': ['difc', 'dubai international financial centre'],
                'ADGM Law': ['adgm', 'abu dhabi global market'],
                'Kingdom of Saudi Arabia': ['saudi arabia', 'riyadh', 'jeddah', 'mecca', 'medina', 'dammam'],
                'Kingdom of Bahrain': ['bahrain', 'manama'],
                'State of Qatar': ['qatar', 'doha'],
                'Sultanate of Oman': ['oman', 'muscat'],
                'State of Kuwait': ['kuwait'],
                'Hashemite Kingdom of Jordan': ['jordan', 'amman'],
                'Republic of Lebanon': ['lebanon', 'beirut'],
                'State of Israel': ['israel', 'tel aviv', 'jerusalem', 'haifa', 'herzliya'],
                'Republic of Iraq': ['iraq', 'baghdad', 'erbil'],
                'Islamic Republic of Iran': ['iran', 'tehran'],
                // ── South Asia ──
                'Republic of India': ['india', 'mumbai', 'delhi', 'new delhi', 'bangalore', 'bengaluru', 'hyderabad', 'chennai', 'kolkata', 'pune', 'ahmedabad', 'gurugram', 'gurgaon', 'noida'],
                'Islamic Republic of Pakistan': ['pakistan', 'karachi', 'lahore', 'islamabad'],
                'Republic of Bangladesh': ['bangladesh', 'dhaka', 'chittagong'],
                'Democratic Socialist Republic of Sri Lanka': ['sri lanka', 'colombo'],
                'Federal Democratic Republic of Nepal': ['nepal', 'kathmandu'],
                // ── East Asia ──
                "People's Republic of China": ['china', 'beijing', 'shanghai', 'shenzhen', 'guangzhou', 'hangzhou', 'chengdu', 'nanjing', 'wuhan', 'tianjin', 'suzhou', 'xiamen'],
                'Japan': ['japan', 'tokyo', 'osaka', 'yokohama', 'nagoya', 'kyoto', 'fukuoka', 'sapporo', 'kobe'],
                'Republic of Korea': ['south korea', 'seoul', 'busan', 'incheon', 'daegu'],
                'Republic of China (Taiwan)': ['taiwan', 'taipei'],
                'Mongolia': ['mongolia', 'ulaanbaatar'],
                // ── Southeast Asia ──
                'Singapore': ['singapore'],
                'Hong Kong': ['hong kong'],
                'Macau': ['macau', 'macao'],
                'Kingdom of Thailand': ['thailand', 'bangkok', 'chiang mai', 'phuket', 'pattaya'],
                'Socialist Republic of Vietnam': ['vietnam', 'viet nam', 'ho chi minh', 'hanoi'],
                'Republic of Indonesia': ['indonesia', 'jakarta', 'bali', 'surabaya', 'bandung'],
                'Malaysia': ['malaysia', 'kuala lumpur', 'penang', 'johor bahru', 'labuan'],
                'Republic of the Philippines': ['philippines', 'manila', 'makati', 'cebu', 'quezon city'],
                'Kingdom of Cambodia': ['cambodia', 'phnom penh', 'siem reap'],
                "Lao People's Democratic Republic": ['laos', 'vientiane'],
                'Republic of the Union of Myanmar': ['myanmar', 'yangon', 'naypyidaw'],
                'Brunei Darussalam': ['brunei', 'bandar seri begawan'],
                // ── Oceania ──
                'Australia': ['australia', 'sydney', 'melbourne', 'brisbane', 'perth', 'adelaide', 'canberra', 'gold coast', 'hobart'],
                'New Zealand': ['new zealand', 'auckland', 'wellington', 'christchurch', 'queenstown'],
                'Republic of Fiji': ['fiji', 'suva'],
                'Independent State of Papua New Guinea': ['papua new guinea', 'port moresby'],
                // ── Latin America & Caribbean ──
                'United Mexican States': ['mexico', 'méxico', 'mexico city', 'ciudad de méxico', 'guadalajara', 'monterrey', 'cancún', 'puebla', 'tijuana'],
                'Federative Republic of Brazil': ['brazil', 'brasil', 'são paulo', 'sao paulo', 'rio de janeiro', 'brasília', 'brasilia', 'belo horizonte', 'curitiba', 'salvador', 'fortaleza'],
                'Argentine Republic': ['argentina', 'buenos aires', 'córdoba', 'rosario', 'mendoza'],
                'Republic of Chile': ['chile', 'santiago', 'valparaíso', 'concepción'],
                'Republic of Colombia': ['colombia', 'bogotá', 'bogota', 'medellín', 'medellin', 'cali', 'barranquilla', 'cartagena'],
                'Republic of Peru': ['peru', 'perú', 'lima', 'arequipa', 'cusco'],
                'Bolivarian Republic of Venezuela': ['venezuela', 'caracas'],
                'Republic of Ecuador': ['ecuador', 'quito', 'guayaquil'],
                'Republic of Paraguay': ['paraguay', 'asunción', 'asuncion'],
                'Eastern Republic of Uruguay': ['uruguay', 'montevideo', 'punta del este'],
                'Plurinational State of Bolivia': ['bolivia', 'la paz', 'santa cruz'],
                'Republic of Panama': ['panama', 'panamá', 'panama city'],
                'Republic of Costa Rica': ['costa rica', 'san josé, costa rica'],
                'Republic of Guatemala': ['guatemala'],
                'Republic of Honduras': ['honduras', 'tegucigalpa'],
                'Republic of El Salvador': ['el salvador', 'san salvador'],
                'Republic of Nicaragua': ['nicaragua', 'managua'],
                'Republic of Cuba': ['cuba', 'havana', 'la habana'],
                'Dominican Republic': ['dominican republic', 'santo domingo', 'punta cana'],
                'Republic of Haiti': ['haiti', 'port-au-prince'],
                'Jamaica': ['jamaica', 'kingston, jamaica'],
                'Republic of Trinidad and Tobago': ['trinidad', 'tobago', 'port of spain'],
                'Barbados': ['barbados', 'bridgetown'],
                'Commonwealth of The Bahamas': ['bahamas', 'nassau, bahamas'],
                'Belize': ['belize', 'belize city', 'belmopan'],
                'Republic of Suriname': ['suriname', 'paramaribo'],
                'Co-operative Republic of Guyana': ['guyana', 'georgetown, guyana'],
                // ── Africa ──
                'Republic of South Africa': ['south africa', 'johannesburg', 'cape town', 'durban', 'pretoria'],
                'Federal Republic of Nigeria': ['nigeria', 'lagos', 'abuja', 'port harcourt'],
                'Republic of Kenya': ['kenya', 'nairobi', 'mombasa'],
                'Republic of Ghana': ['ghana', 'accra', 'kumasi'],
                'Republic of Tanzania': ['tanzania', 'dar es salaam', 'dodoma'],
                'Republic of Uganda': ['uganda', 'kampala'],
                'Republic of Rwanda': ['rwanda', 'kigali'],
                'Federal Democratic Republic of Ethiopia': ['ethiopia', 'addis ababa'],
                'Arab Republic of Egypt': ['egypt', 'cairo', 'alexandria', 'giza'],
                'Kingdom of Morocco': ['morocco', 'maroc', 'casablanca', 'rabat', 'marrakech', 'tangier'],
                'Republic of Tunisia': ['tunisia', 'tunis'],
                "People's Democratic Republic of Algeria": ['algeria', 'algiers'],
                'State of Libya': ['libya', 'tripoli, libya'],
                'Republic of Senegal': ['senegal', 'dakar'],
                "Republic of Côte d'Ivoire": ['ivory coast', "côte d'ivoire", 'abidjan'],
                'Republic of Cameroon': ['cameroon', 'douala', 'yaoundé'],
                'Democratic Republic of the Congo': ['congo', 'kinshasa'],
                'Republic of Angola': ['angola', 'luanda'],
                'Republic of Mozambique': ['mozambique', 'maputo'],
                'Republic of Zimbabwe': ['zimbabwe', 'harare'],
                'Republic of Zambia': ['zambia', 'lusaka'],
                'Republic of Botswana': ['botswana', 'gaborone'],
                'Republic of Namibia': ['namibia', 'windhoek'],
                'Republic of Madagascar': ['madagascar', 'antananarivo'],
                'Republic of Malawi': ['malawi', 'lilongwe'],
                'Republic of the Sudan': ['sudan', 'khartoum'],
                'Republic of South Sudan': ['south sudan', 'juba'],
                'Somali Republic': ['somalia', 'mogadishu'],
                'Republic of Djibouti': ['djibouti'],
                'State of Eritrea': ['eritrea', 'asmara'],
                'Republic of Niger': ['niger', 'niamey'],
                'Republic of Mali': ['mali', 'bamako'],
                'Burkina Faso': ['burkina faso', 'ouagadougou'],
                'Republic of Chad': ['chad', "n'djamena"],
                'Republic of Guinea': ['guinea', 'conakry'],
                'Republic of Sierra Leone': ['sierra leone', 'freetown'],
                'Republic of Liberia': ['liberia', 'monrovia'],
                'Togolese Republic': ['togo', 'lomé'],
                'Republic of Benin': ['benin', 'cotonou', 'porto-novo'],
                'Gabonese Republic': ['gabon', 'libreville'],
                'Republic of Equatorial Guinea': ['equatorial guinea', 'malabo'],
                'Republic of the Congo': ['brazzaville', 'republic of the congo'],
                'Central African Republic': ['central african republic', 'bangui'],
                'Republic of Mauritius': ['mauritius', 'port louis'],
                'Republic of Seychelles': ['seychelles', 'mahé', 'victoria, seychelles'],
                // ── Offshore / Special Jurisdictions ──
                'British Virgin Islands': ['british virgin islands', 'bvi', 'tortola', 'road town'],
                'Cayman Islands': ['cayman islands', 'george town, cayman', 'grand cayman'],
                'Bermuda': ['bermuda', 'hamilton, bermuda'],
                'Jersey': ['jersey', 'saint helier', 'st helier'],
                'Guernsey': ['guernsey', 'st peter port'],
                'Isle of Man': ['isle of man', 'douglas, isle of man'],
                'Gibraltar': ['gibraltar'],
                'Republic of the Marshall Islands': ['marshall islands', 'majuro'],
                'Republic of Vanuatu': ['vanuatu', 'port vila'],
                'Principality of Monaco': ['monaco', 'monte carlo'],
                'Republic of San Marino': ['san marino'],
                'Principality of Andorra': ['andorra', 'andorra la vella'],
                'Curaçao': ['curaçao', 'curacao', 'willemstad'],
                'Aruba': ['aruba', 'oranjestad'],
                'Saint Kitts and Nevis': ['saint kitts', 'st kitts', 'nevis', 'basseterre'],
                'Antigua and Barbuda': ['antigua', 'barbuda'],
                'Saint Lucia': ['saint lucia', 'st lucia', 'castries'],
                'Saint Vincent and the Grenadines': ['saint vincent', 'st vincent'],
                'Commonwealth of Dominica': ['dominica', 'roseau'],
                'Republic of Palau': ['palau'],
                'Samoa': ['samoa', 'apia'],
                'Kingdom of Tonga': ['tonga'],
            };
            for (const [law, keywords] of Object.entries(map)) {
                for (const kw of keywords) {
                    if (addr.includes(kw)) return law;
                }
            }
            return null;
        }

        function toggleCustomGoverningLaw() {
            const sel = document.getElementById('governingLaw');
            const customInput = document.getElementById('governingLawCustom');
            customInput.classList.toggle('hidden', sel.value !== 'custom');
        }

        function updateGoverningLawOptions() {
            const sel = document.getElementById('governingLaw');
            const current = sel.value;
            sel.innerHTML = '';

            // Detect jurisdictions from party addresses
            const addrA = document.getElementById('partyAAddress').value;
            const addrB = document.getElementById('partyBAddress').value;
            const jurA = detectJurisdictionFromAddress(addrA);
            const jurB = detectJurisdictionFromAddress(addrB);

            // Party A option (default)
            const optA = document.createElement('option');
            optA.value = 'partyA';
            optA.textContent = jurA ? `${jurA} (Party A)` : 'Party A jurisdiction (default)';
            sel.appendChild(optA);

            // Party B option (if different)
            if (jurB && jurB !== jurA) {
                const optB = document.createElement('option');
                optB.value = jurB;
                optB.textContent = `${jurB} (Party B)`;
                sel.appendChild(optB);
            }

            // Custom option
            const customOpt = document.createElement('option');
            customOpt.value = 'custom';
            customOpt.textContent = 'Custom (type your own)...';
            sel.appendChild(customOpt);

            // Restore previous selection if still valid
            if (current && current !== 'partyA') {
                const exists = Array.from(sel.options).some(o => o.value === current);
                if (exists) sel.value = current;
                else sel.value = 'partyA';
            } else {
                sel.value = 'partyA';
            }
            toggleCustomGoverningLaw();
        }

        // ═══════ Step Navigation ═══════
        function goToStep2() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('footerCTA').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function goToStep3() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('footerCTA').classList.add('hidden');
            document.getElementById('summarySource').textContent = generatedNDAText2 ? 'Enhanced NDA' : 'Flash NDA';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function goToStep4() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            document.getElementById('footerCTA').classList.add('hidden');
            buildEmailTemplate();
            updateBadge(4);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function backToStep3() {
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function backToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            if (generatedNDAText) document.getElementById('footerCTA').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function backToResults() {
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');
            if (generatedNDAText2) {
                document.getElementById('step2').classList.remove('hidden');
            } else {
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('footerCTA').classList.remove('hidden');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function buildEmailTemplate() {
            const recipientName = document.getElementById('partyBSignatory').value || '[Name]';
            const senderName = document.getElementById('partyASignatory').value || '[Your Name]';
            const senderTitle = document.getElementById('partyATitle').value;
            const partyAName = document.getElementById('partyAName').value || '[Your Company]';
            const partyBName = document.getElementById('partyBName').value || '[Their Company]';
            const purpose = getPurpose();
            const confPeriod = document.getElementById('confPeriod').value;

            // Build a short purpose phrase for the subject
            const purposeShort = document.getElementById('purposeSelect').value === 'custom'
                ? 'Our Discussion'
                : document.getElementById('purposeSelect').options[document.getElementById('purposeSelect').selectedIndex].text;

            const subject = `NDA for ${purposeShort} — ${partyAName} / ${partyBName}`;

            const body = `Dear ${recipientName},

Looking forward to our conversation regarding ${purpose.charAt(0).toLowerCase() + purpose.slice(1).replace(/\.$/, '')}. 

Before we proceed with sharing any confidential information, I have attached a Non-Disclosure Agreement for your review. The agreement is straightforward — it provides standard ${confPeriod}-year confidentiality protections on what we share, with standard exclusions for publicly available information and materials already in your possession.

${generatedSummaryText ? 'I have also attached a plain-English summary so you can see exactly what the agreement covers without having to parse legal language.\n\n' : ''}Please review the attached at your convenience. If you have any questions or would like to suggest any amendments, I am happy to discuss.

Once you are comfortable with the terms, please countersign and return a copy at your earliest convenience so we can move forward.

Best regards,
${senderName}${senderTitle ? '\n' + senderTitle : ''}
${partyAName}`;

            document.getElementById('emailSubject').value = subject;
            document.getElementById('emailBody').value = body;
        }

        function copyEmailText() {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const full = `Subject: ${subject}\n\n${body}`;
            navigator.clipboard.writeText(full).then(() => {
                const msg = document.getElementById('emailCopied');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 2000);
            });
        }

        function openInMailClient() {
            const to = document.getElementById('partyBEmail').value || '';
            const subject = encodeURIComponent(document.getElementById('emailSubject').value);
            const body = encodeURIComponent(document.getElementById('emailBody').value);
            window.open(`mailto:${to}?subject=${subject}&body=${body}`, '_blank');
        }

        function updateBadge(step) {
            for (let i = 1; i <= 4; i++) {
                const badge = document.getElementById(`step${i}-badge`);
                if (i < step) {
                    badge.className = 'step-badge done';
                    badge.querySelector('.step-num').textContent = '✓';
                } else if (i === step) {
                    badge.className = 'step-badge active';
                    badge.querySelector('.step-num').textContent = i === 1 ? '1' : '+';
                } else {
                    badge.className = 'step-badge inactive';
                    badge.querySelector('.step-num').textContent = '+';
                }
            }
        }

        function toggleSolicitFields() {
            const on = document.getElementById('prohibitSoliciting').value === 'Yes';
            document.getElementById('solicitScopeGroup').style.display = on ? '' : 'none';
            document.getElementById('solicitRow2').style.display = on ? '' : 'none';
        }
        function toggleCompeteFields() {
            const on = document.getElementById('nonCompete').value === 'Yes';
            document.getElementById('competeDurationGroup').style.display = on ? '' : 'none';
            document.getElementById('competeRow2').style.display = on ? '' : 'none';
        }
        function toggleBreachFields() {
            const val = document.getElementById('breachRemedy').value;
            const show = val !== 'Damages';
            document.getElementById('breachAmountGroup').style.display = show ? '' : 'none';
            document.getElementById('breachAmountLabel').textContent = val === 'Penalty' ? 'Penalty Amount' : 'Liquidated Damages Amount';
            document.getElementById('breachWarning').classList.toggle('hidden', val !== 'Penalty');
        }
        function toggleBreachCurrency() {
            const sel = document.getElementById('breachCurrency');
            document.getElementById('breachCurrencyCustom').classList.toggle('hidden', sel.value !== 'custom');
        }
        function getBreachCurrency() {
            const sel = document.getElementById('breachCurrency').value;
            return sel === 'custom' ? (document.getElementById('breachCurrencyCustom').value || 'USD') : sel;
        }

        function toggleArbFields() {
            const val = document.getElementById('disputeMethod').value;
            const arbFields = document.getElementById('arbFields');
            arbFields.classList.toggle('hidden', val === 'Courts');
            if (val !== 'Courts') {
                onArbInstitutionChange();
            }
        }

        const ARB_INSTITUTIONS = {
            ICC: {
                name: 'International Chamber of Commerce (ICC)',
                defaultSeat: 'Paris, France',
                modelClause: (seat, lang, govLaw, numArb) =>
                    `All disputes arising out of or in connection with this Agreement shall be finally settled under the Rules of Arbitration of the International Chamber of Commerce by ${numArb === '3' ? 'three arbitrators' : 'a sole arbitrator'} appointed in accordance with the said Rules. The seat of arbitration shall be ${seat}. The language of the arbitration shall be ${lang}. The arbitral proceedings and the award shall be kept confidential. The award shall be final and binding upon the Parties, who hereby waive any right to any form of recourse insofar as such waiver can validly be made. The prevailing Party shall be entitled to recover its reasonable legal fees and costs from the other Party.`
            },
            LCIA: {
                name: 'London Court of International Arbitration (LCIA)',
                defaultSeat: 'London, England',
                modelClause: (seat, lang, govLaw, numArb) =>
                    `Any dispute arising out of or in connection with this Agreement, including any question regarding its existence, validity or termination, shall be referred to and finally resolved by arbitration under the LCIA Rules, which Rules are deemed to be incorporated by reference into this clause. The number of arbitrators shall be ${numArb === '3' ? 'three' : 'one'}. The seat, or legal place, of arbitration shall be ${seat}. The language to be used in the arbitral proceedings shall be ${lang}. The governing law of this Agreement shall be the substantive law of ${govLaw || '[governing law jurisdiction]'}. The arbitral proceedings and the award shall be kept confidential. The prevailing Party shall be entitled to recover its reasonable legal fees and costs.`
            },
            AAA_ICDR: {
                name: 'International Centre for Dispute Resolution (ICDR)',
                defaultSeat: 'New York, USA',
                modelClause: (seat, lang, govLaw, numArb) =>
                    `Any controversy or claim arising out of or relating to this Agreement, or the breach thereof, shall be determined by arbitration administered by the International Centre for Dispute Resolution in accordance with its International Arbitration Rules. The number of arbitrators shall be ${numArb === '3' ? 'three' : 'one'}. The place of arbitration shall be ${seat}. The arbitration shall be held, and the award shall be rendered, in ${lang}. The award rendered by the arbitrator${numArb === '3' ? 's' : ''} shall be final and binding upon the Parties, and judgment on the award may be entered in any court having jurisdiction thereof. The arbitral proceedings and the award shall be kept confidential. The prevailing Party shall be entitled to recover its reasonable attorneys' fees and costs.`
            },
            SIAC: {
                name: 'Singapore International Arbitration Centre (SIAC)',
                defaultSeat: 'Singapore',
                modelClause: (seat, lang, govLaw, numArb) =>
                    `Any dispute arising out of or in connection with this Agreement, including any question regarding its existence, validity or termination, shall be referred to and finally resolved by arbitration administered by the Singapore International Arbitration Centre ("SIAC") in accordance with the Arbitration Rules of the Singapore International Arbitration Centre ("SIAC Rules") for the time being in force, which rules are deemed to be incorporated by reference in this clause. The seat of the arbitration shall be ${seat}. The Tribunal shall consist of ${numArb === '3' ? 'three arbitrators' : 'one arbitrator'}. The language of the arbitration shall be ${lang}. The award shall be final and binding upon the Parties. The arbitral proceedings and the award shall be kept confidential. The prevailing Party shall be entitled to recover its reasonable legal fees and costs.`
            },
            SCC: {
                name: 'Arbitration Institute of the Stockholm Chamber of Commerce (SCC)',
                defaultSeat: 'Stockholm, Sweden',
                modelClause: (seat, lang, govLaw, numArb) =>
                    `Any dispute, controversy or claim arising out of or in connection with this Agreement, or the breach, termination or invalidity thereof, shall be finally settled by arbitration in accordance with the Arbitration Rules of the Arbitration Institute of the Stockholm Chamber of Commerce. The arbitral tribunal shall be composed of ${numArb === '3' ? 'three arbitrators' : 'a sole arbitrator'}. The seat of arbitration shall be ${seat}. The language to be used in the arbitral proceedings shall be ${lang}. This Agreement shall be governed by the substantive law of ${govLaw || '[governing law jurisdiction]'}. The arbitral proceedings and the award shall be kept confidential. The prevailing Party shall be entitled to recover its reasonable legal fees and costs.`
            },
            DIAC: {
                name: 'Dubai International Arbitration Centre (DIAC)',
                defaultSeat: 'Dubai, UAE',
                modelClause: (seat, lang, govLaw, numArb) =>
                    `Any dispute arising out of the formation, performance, interpretation, nullification, termination or invalidation of this Agreement or arising therefrom or related thereto in any manner whatsoever, shall be settled by arbitration in accordance with the Arbitration Rules of the Dubai International Arbitration Centre ("DIAC Rules"), by ${numArb === '3' ? 'three arbitrators' : 'a sole arbitrator'} appointed in compliance with the DIAC Rules. The seat of arbitration shall be ${seat}. The language of arbitration shall be ${lang}. The award shall be final and binding upon the Parties. The arbitral proceedings and the award shall be kept confidential. The prevailing Party shall be entitled to recover its reasonable legal fees and costs.`
            }
        };

        function onArbInstitutionChange() {
            const key = document.getElementById('arbRules').value;
            const inst = ARB_INSTITUTIONS[key];
            if (!inst) return;

            // Auto-fill seat if empty or still a default
            const seatInput = document.getElementById('arbLocation');
            const allDefaults = Object.values(ARB_INSTITUTIONS).map(i => i.defaultSeat);
            if (!seatInput.value || allDefaults.includes(seatInput.value)) {
                seatInput.value = inst.defaultSeat;
            }

            // Update clause preview
            updateArbClausePreview();
        }

        function updateArbClausePreview() {
            const key = document.getElementById('arbRules').value;
            const inst = ARB_INSTITUTIONS[key];
            if (!inst) return;

            const seat = document.getElementById('arbLocation').value || inst.defaultSeat;
            const lang = document.getElementById('arbLanguage').value || 'English';
            const govLaw = getGoverningLaw() || '[governing law jurisdiction]';
            const numArb = document.getElementById('arbCount').value || '1';
            const clause = inst.modelClause(seat, lang, govLaw, numArb);

            document.getElementById('arbClauseText').textContent = clause;
            document.getElementById('arbClausePreview').style.display = 'block';
        }

        // Update preview when seat or language changes
        document.addEventListener('DOMContentLoaded', () => {
            const arbLoc = document.getElementById('arbLocation');
            const arbLang = document.getElementById('arbLanguage');
            if (arbLoc) arbLoc.addEventListener('input', updateArbClausePreview);
            if (arbLang) arbLang.addEventListener('change', updateArbClausePreview);
        });

        // ═══════ Entity Type Auto-Detection ═══════
        function detectEntityType(name, fallback) {
            if (!name) return fallback || '';
            const n = name.toLowerCase().trim();
            const patterns = [
                [/\bpte\.?\s*ltd\.?$/,  'private limited company (Pte. Ltd.)'],
                [/\bltd\.?$/,          'private limited company (Ltd)'],
                [/\blimited$/,         'private limited company (Limited)'],
                [/\bplc\.?$/,          'public limited company (PLC)'],
                [/\bllp$/,             'limited liability partnership (LLP)'],
                [/\blp$/,              'limited partnership (LP)'],
                [/\bllc\.?$/,          'limited liability company (LLC)'],
                [/\binc\.?$/,          'corporation (Inc.)'],
                [/\bcorp\.?$/,         'corporation (Corp.)'],
                [/\bcorporation$/,     'corporation'],
                [/\boü$/,              'private limited company (OÜ)'],
                [/\bas$/,              'public limited company (AS)'],
                [/\bmtü$/,            'non-profit association (MTÜ)'],
                [/\bfie$/,             'sole proprietor (FIE)'],
                [/\bgmbh\s*&?\s*co\.?\s*kg$/,  'limited partnership (GmbH & Co. KG)'],
                [/\bgmbh$/,            'limited liability company (GmbH)'],
                [/\bag$/,              'stock corporation (AG)'],
                [/\bug\b.*haftungsbeschränkt/, 'entrepreneurial company (UG)'],
                [/\bb\.?\s*v\.?$/,     'private limited company (B.V.)'],
                [/\bn\.?\s*v\.?$/,     'public limited company (N.V.)'],
                [/\bsarl$/,            'limited liability company (SARL)'],
                [/\bsas$/,             'simplified joint-stock company (SAS)'],
                [/\bs\.?\s*l\.?$/,     'limited liability company (S.L.)'],
                [/\bs\.?\s*r\.?\s*o\.?$/, 'limited liability company (s.r.o.)'],
                [/\ba\.?\s*s\.?$/,     'joint-stock company (a.s.)'],
                [/\bv\.?\s*o\.?\s*s\.?$/, 'general partnership (v.o.s.)'],
                [/\bk\.?\s*s\.?$/,     'limited partnership (k.s.)'],
                [/\bsp\.?\s*z\.?\s*o\.?\s*o\.?$/, 'limited liability company (sp. z o.o.)'],
                [/\buab$/,             'private limited company (UAB)'],
                [/\bab$/,              'public limited company (AB)'],
                [/\bfz-?llc$/,         'free zone LLC (FZ-LLC)'],
                [/\bfze$/,             'free zone establishment (FZE)'],
                [/\bs\.?\s*r\.?\s*l\.?$/, 'limited liability company (S.r.l.)'],
                [/\bs\.?\s*p\.?\s*a\.?$/, 'joint-stock company (S.p.A.)'],
                [/\bs\.?\s*a\.?$/,     'public limited company (S.A.)'],
                [/\bpartnership$/,     'partnership'],
                [/\btrust$/,           'trust'],
                [/\bfoundation$/,      'foundation'],
            ];
            for (const [regex, type] of patterns) {
                if (regex.test(n)) return type;
            }
            if (fallback && fallback !== 'Company') {
                const map = { 'LTD': 'private limited company', 'LLC': 'limited liability company',
                    'Corporation': 'corporation', 'Partnership': 'partnership', 'Individual': 'individual' };
                return map[fallback] || fallback;
            }
            return '';
        }

        // ═══════ NDA Generation ═══════
        function buildPrompt1() {
            const pA = {
                name: document.getElementById('partyAName').value || '[Party A Name]',
                companyNumber: document.getElementById('partyACompanyNumber').value,
                address: document.getElementById('partyAAddress').value || '[Party A Address]',
                email: document.getElementById('partyAEmail').value,
                signatory: document.getElementById('partyASignatory').value,
                title: document.getElementById('partyATitle').value
            };
            const pB = {
                name: document.getElementById('partyBName').value || '[Party B Name]',
                companyNumber: document.getElementById('partyBCompanyNumber').value,
                address: document.getElementById('partyBAddress').value || '[Party B Address]',
                email: document.getElementById('partyBEmail').value,
                role: document.getElementById('partyBRole').value,
                signatory: document.getElementById('partyBSignatory').value,
                title: document.getElementById('partyBTitle').value
            };
            pA.type = detectEntityType(pA.name, document.getElementById('partyAType').value);
            pB.type = detectEntityType(pB.name, document.getElementById('partyBType').value);

            const confInfo = Array.from(document.querySelectorAll('.confInfo:checked')).map(cb => cb.value).join(', ') || 'business information';
            let formattedDate = '[Date]';
            const dateVal = document.getElementById('agreementDate').value;
            if (dateVal) formattedDate = new Date(dateVal).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const isMutual = document.getElementById('ndaType').value === 'Mutual';
            const confPeriod = document.getElementById('confPeriod').value;
            const govLaw = getGoverningLaw() || '[Governing Law Jurisdiction]';
            const bindOthers = document.getElementById('bindOthers').value;

            return `You are a senior international corporate lawyer. Draft a comprehensive, enforceable Non-Disclosure Agreement. The agreement must be internally consistent: every defined term must be defined exactly once and used identically throughout, every section cross-reference must be numerically accurate, and no provision may contradict another.

═══ PARTY DETAILS ═══

PARTY A:
- Full Legal Name: ${pA.name}
- Entity Type: ${pA.type || '(determine from company name and jurisdiction)'}${pA.companyNumber ? `\n- Registration/Company Number: ${pA.companyNumber}` : ''}
- Registered Address: ${pA.address}
- Email: ${pA.email || '[Email]'}${pA.signatory ? `\n- Authorised Signatory: ${pA.signatory}` : ''}${pA.title ? `\n- Title/Position: ${pA.title}` : ''}

PARTY B:
- Full Legal Name: ${pB.name}
- Entity Type: ${pB.type || '(determine from company name and jurisdiction)'}${pB.companyNumber ? `\n- Registration/Company Number: ${pB.companyNumber}` : ''}
- Registered Address: ${pB.address}
- Email: ${pB.email || '[Email]'}${pB.signatory ? `\n- Authorised Signatory: ${pB.signatory}` : ''}${pB.title ? `\n- Title/Position: ${pB.title}` : ''}

═══ KEY PARAMETERS ═══

NDA TYPE: ${isMutual ? 'Mutual (both Parties may disclose and receive Confidential Information)' : 'Unilateral (Party A discloses, Party B receives)'}
PURPOSE: ${getPurpose()}
GOVERNING LAW: ${govLaw}
CONFIDENTIALITY SURVIVAL PERIOD: ${confPeriod} year(s) after termination or expiry
EFFECTIVE DATE: ${formattedDate}
BIND REPRESENTATIVES: ${bindOthers}
CONFIDENTIAL INFORMATION CATEGORIES: ${confInfo}

═══ DOCUMENT STRUCTURE ═══

# ${isMutual ? 'MUTUAL ' : ''}NON-DISCLOSURE AGREEMENT

**Effective Date: ${formattedDate}**

Opening paragraph:
"This ${isMutual ? 'Mutual ' : ''}Non-Disclosure Agreement (hereinafter the **"Agreement"**) is entered into as of the Effective Date by and between:"

Identify each Party with: bold legal name, entity type (e.g., "a private limited company incorporated under the laws of [jurisdiction]"), registration number if provided, registered address. Then: "hereinafter referred to as **"Party A"**" / **"Party B"**, each individually a **"Party"** and collectively the **"Parties"**.

WHEREAS recitals:
1. ${isMutual ? 'WHEREAS, each Party possesses certain confidential and proprietary information, and the Parties wish to explore and evaluate a potential business relationship' : 'WHEREAS, Party A possesses certain confidential and proprietary information and wishes to disclose such information to Party B'} for the following purpose: ${getPurpose()} (hereinafter the **"Purpose"**).
2. WHEREAS, ${isMutual ? 'in the course of pursuing the Purpose, each Party (when disclosing Confidential Information, the **"Disclosing Party"**; when receiving Confidential Information, the **"Receiving Party"**) may disclose' : 'Party A (the **"Disclosing Party"**) wishes to disclose, and Party B (the **"Receiving Party"**) wishes to receive,'} Confidential Information solely in connection with the Purpose.
3. WHEREAS, the Parties wish to establish the terms and conditions governing the disclosure, receipt, and protection of such Confidential Information.

"NOW, THEREFORE, in consideration of the mutual covenants and agreements contained herein, and for other good and valuable consideration, the receipt and sufficiency of which are hereby acknowledged, the Parties agree as follows:"

═══ SECTIONS — follow this exact numbering ═══

## 1. Definitions and Interpretation.
1.1. **"Confidential Information"** means all non-public information, whether in written, oral, electronic, visual, or any other form, disclosed by or on behalf of the Disclosing Party to the Receiving Party, directly or indirectly, that relates to the business, operations, finances, technology, products, services, or affairs of the Disclosing Party. Confidential Information includes information that is expressly marked or designated as confidential, as well as information that a reasonable person would understand to be confidential given the nature of the information and the circumstances of its disclosure.

1.2. Without limiting the generality of the foregoing, Confidential Information includes the following categories:
Provide a DETAILED enumerated list of at least 10 specific items based on: ${confInfo}. Cover at minimum: (a) corporate structure, ownership, and governance documents; (b) trade secrets, proprietary processes, and know-how; (c) business plans, strategies, and financial projections; (d) financial data, pricing models, and cost structures; (e) client lists, customer data, and supplier information; (f) investor information and fundraising activities; (g) employee and contractor information, compensation data; (h) intellectual property, patents, trademarks, copyrights, and licence agreements; (i) source code, algorithms, technical designs, and specifications; (j) security systems, access protocols, and cybersecurity measures; (k) marketing strategies and business development plans; (l) any information expressly marked or designated as "Confidential" or "Proprietary"; (m) any other information disclosed in connection with the Purpose.

1.3. **"Unlawful Disclosure"** means any unauthorised disclosure, use, copying, reproduction, or exploitation of Confidential Information in breach of this Agreement.

${bindOthers === 'Yes' ? '1.4. **"Authorised Recipients"** means the Receiving Party\'s directors, officers, employees, contractors, and professional advisors who have a legitimate need to access Confidential Information solely for the Purpose and who are bound by written confidentiality obligations no less restrictive than those contained in this Agreement.' : ''}

1.${bindOthers === 'Yes' ? '5' : '4'}. **Interpretation.** In this Agreement: (a) headings are for convenience only and shall not affect interpretation; (b) "including" and similar expressions mean "including but not limited to"; (c) references to any statute or regulation include any amendments, re-enactments, or successor legislation; (d) words in the singular include the plural and vice versa; (e) references to Sections are to sections of this Agreement.

## 2. Exclusions from Confidential Information.
2.1. Information shall not constitute Confidential Information if the Receiving Party can demonstrate by documentary evidence that such information:
(a) was in the public domain at the time of disclosure, or subsequently entered the public domain through no fault, act, or omission of the Receiving Party;
(b) was lawfully in the Receiving Party's possession prior to disclosure by the Disclosing Party, without any obligation of confidentiality;
(c) was independently developed by the Receiving Party without reference to or use of the Confidential Information; or
(d) was lawfully received from a third party who was not subject to any obligation of confidentiality with respect to such information.

2.2. The burden of proving any exclusion under this Section 2 rests solely with the Receiving Party. Any combination of information shall be treated as Confidential Information even if individual components are within the public domain, provided that the specific combination is not in the public domain.

## 3. Confidentiality Obligations.
3.1. The Receiving Party shall:
(a) hold all Confidential Information in strict confidence and not disclose it to any person except as expressly permitted under this Agreement;
(b) use the Confidential Information solely for the Purpose and for no other purpose whatsoever;
(c) not copy, reproduce, or reduce to writing any Confidential Information except as strictly necessary for the Purpose;
(d) apply no less a degree of care to protect the Confidential Information than it applies to protect its own confidential information of a similar nature, and in any event no less than reasonable care;
(e) restrict access to Confidential Information to ${bindOthers === 'Yes' ? 'its Authorised Recipients' : 'its directors and officers'} who have a genuine need to know for the Purpose; and
(f) promptly notify the Disclosing Party in writing upon becoming aware of any actual or suspected Unlawful Disclosure.

${bindOthers === 'Yes' ? '3.2. Prior to granting any Authorised Recipient access to Confidential Information, the Receiving Party shall ensure that such Authorised Recipient: (a) has been informed of the confidential nature of the information; and (b) is bound by written confidentiality obligations no less restrictive than this Agreement. The Receiving Party shall remain fully liable for any breach by its Authorised Recipients as if it were a direct breach by the Receiving Party.' : '3.2. The Receiving Party shall not disclose any Confidential Information to any employee, contractor, or agent without the prior written consent of the Disclosing Party.'}

## 4. Permitted Disclosure.
4.1. The Receiving Party may disclose Confidential Information to ${bindOthers === 'Yes' ? 'its Authorised Recipients' : 'its directors and officers'} solely to the extent necessary for the Purpose, subject to the obligations in Section 3.

4.2. If the Receiving Party or any ${bindOthers === 'Yes' ? 'Authorised Recipient' : 'person to whom disclosure is permitted'} becomes legally compelled by any applicable law, regulation, judicial or governmental order, or proceeding to disclose any Confidential Information, the Receiving Party shall, to the extent legally permitted:
(a) provide the Disclosing Party with prompt prior written notice of such requirement;
(b) cooperate with the Disclosing Party in seeking a protective order or other appropriate remedy;
(c) disclose only the minimum portion of Confidential Information that is legally required; and
(d) use commercially reasonable efforts to obtain confidential treatment for any information so disclosed.

4.3. Any disclosure made pursuant to Section 4.2 shall not relieve the Receiving Party of its obligations under this Agreement with respect to any Confidential Information not so disclosed.

## 5. Return or Destruction of Confidential Information.
5.1. Upon the earlier of: (a) written request by the Disclosing Party; or (b) termination or expiry of this Agreement, the Receiving Party shall promptly:
(i) return to the Disclosing Party all originals and copies of Confidential Information in any form;
(ii) permanently delete or destroy all Confidential Information stored in electronic systems, databases, or any other media under its control or the control of its ${bindOthers === 'Yes' ? 'Authorised Recipients' : 'representatives'}; and
(iii) provide the Disclosing Party with written certification of compliance, signed by an authorised officer, confirming that all Confidential Information has been returned or destroyed.

5.2. Notwithstanding Section 5.1, the Receiving Party may retain copies of Confidential Information to the extent required by applicable law or regulation, or contained in routine electronic backup systems, provided that all retained copies shall remain subject to the confidentiality obligations of this Agreement for the duration of their retention.

## 6. Intellectual Property and Reservation of Rights.
6.1. All Confidential Information shall remain the exclusive property of the Disclosing Party. Nothing in this Agreement shall be construed to grant the Receiving Party any licence, right, title, or interest in or to the Confidential Information or any intellectual property of the Disclosing Party.
6.2. Neither Party shall acquire any right or licence under any patent, copyright, trademark, trade secret, or other intellectual property right of the other Party by reason of this Agreement or any disclosure hereunder.
6.3. Nothing in this Agreement shall obligate either Party to enter into any further agreement, proceed with any transaction, or continue any business relationship.

## 7. Remedies.
7.1. The Parties acknowledge that the Confidential Information is of a special and unique character, and that any breach or threatened breach of this Agreement may cause irreparable harm to the Disclosing Party for which monetary damages alone would be an insufficient remedy.
7.2. In the event of any breach or threatened breach, the Disclosing Party shall be entitled to seek injunctive relief, specific performance, and any other equitable remedies available under applicable law, without the requirement to post a bond or other security and without the need to prove actual damages.
7.3. The rights and remedies provided in this Agreement are cumulative and in addition to, not in substitution for, any other rights and remedies available at law or in equity.

## 8. Term and Termination.
8.1. This Agreement shall commence on the Effective Date and remain in force until terminated in accordance with this Section 8.
8.2. Either Party may terminate this Agreement at any time by providing thirty (30) days' prior written notice to the other Party.
8.3. Either Party may terminate this Agreement immediately upon written notice if the other Party commits a material breach of any provision of this Agreement.
8.4. Upon termination or expiry of this Agreement, the provisions of Sections 1, 2, 3, 4.2, 5, 6, 7, and this Section 8.4 shall survive and continue in full force and effect for a period of ${confPeriod} year(s) from the date of termination or expiry.
8.5. Termination of this Agreement shall not release either Party from any liability arising from any breach occurring prior to or upon such termination.

## 9. Dispute Resolution.
9.1. The Parties shall first attempt to resolve any dispute arising out of or in connection with this Agreement through good-faith negotiations for a period of thirty (30) days commencing from the date on which one Party provides the other with written notice of such dispute.
9.2. If the dispute is not resolved within the period specified in Section 9.1, the courts of ${govLaw} shall have exclusive jurisdiction to hear and determine any such dispute. Each Party irrevocably submits to the exclusive jurisdiction of such courts and waives any objection to the laying of venue or any claim of inconvenient forum.

## 10. General Provisions.
10.1. **Assignment.** Neither Party may assign, transfer, or delegate any of its rights or obligations under this Agreement without the prior written consent of the other Party. Any purported assignment in violation of this Section shall be null and void.
10.2. **Entire Agreement.** This Agreement constitutes the entire agreement between the Parties with respect to the subject matter hereof and supersedes all prior and contemporaneous negotiations, representations, warranties, and agreements, whether written or oral.
10.3. **Amendments.** No amendment, modification, or supplement to this Agreement shall be valid or binding unless made in writing and signed by duly authorised representatives of both Parties.
10.4. **Waiver.** No failure or delay by either Party in exercising any right, power, or remedy under this Agreement shall operate as a waiver thereof, nor shall any single or partial exercise preclude any further exercise of such right, power, or remedy.
10.5. **Severability.** If any provision of this Agreement is held by a court of competent jurisdiction to be invalid, illegal, or unenforceable, such provision shall be modified to the minimum extent necessary to render it valid and enforceable, or if modification is not possible, shall be severed from this Agreement. The remaining provisions shall continue in full force and effect.
10.6. **Counterparts.** This Agreement may be executed in any number of counterparts, each of which shall constitute an original, and all of which together shall constitute one and the same agreement. Execution and delivery by electronic means, including PDF or qualified electronic signature, shall be as valid and effective as original ink signatures.
10.7. **Governing Law.** This Agreement shall be governed by and construed in accordance with the laws of ${govLaw}, without regard to its conflict of laws principles.
10.8. **Notices.** All notices, requests, and other communications under this Agreement shall be in writing and shall be deemed duly given: (a) upon delivery, if delivered by hand or internationally recognised courier service; or (b) upon transmission, if sent by email to the addresses specified in the preamble of this Agreement, provided that the sender does not receive an automated non-delivery notification.

**IN WITNESS WHEREOF**, the Parties have executed this Agreement as of the Effective Date.

| **${pA.name}** | **${pB.name}** |
|---|---|
| Signature: ______________________ | Signature: ______________________ |
| Name: ${pA.signatory || '_______________'} | Name: ${pB.signatory || '_______________'} |
| Title: ${pA.title || '_______________'} | Title: ${pB.title || '_______________'} |
| Email: ${pA.email || '_______________'} | Email: ${pB.email || '_______________'} |
| Date: ______________________ | Date: ______________________ |

═══ MANDATORY QUALITY RULES ═══

INTERNAL CONSISTENCY:
- Every defined term (bold, in quotes) must be defined ONCE and used IDENTICALLY throughout. Do not introduce synonyms or variations.
- ${isMutual ? 'MUTUAL NDA: Every obligation MUST apply symmetrically to both Parties. Use "each Party", "the Disclosing Party / the Receiving Party" construction. Do NOT create any asymmetric obligation.' : 'UNILATERAL NDA: Party A is always the Disclosing Party; Party B is always the Receiving Party. Maintain this consistently — never reverse the roles.'}
- All cross-references must be numerically correct (e.g., "pursuant to Section 4.2", "as defined in Section 1.1").
- The governing law in Section 10.7 MUST match the jurisdiction in Section 9.2.
- The survival period in Section 8.4 MUST be "${confPeriod} year(s)".
- Section 8.4 must list the exact section numbers that survive — verify they exist and are correct.

ENFORCEABILITY:
- Use objective, measurable standards: "thirty (30) days", "written notice", "documentary evidence".
- Every obligation must identify: the obligated party, the required action, and the scope or limitation.
- The exclusions in Section 2 must use the "demonstrate by documentary evidence" standard consistently.
- Remedies must preserve both equitable (injunctive, specific performance) and legal (damages) relief.

FORMATTING:
- Professional legal English — formal, precise, enforceable.
- "shall" for obligations, "may" for permissions.
- Bold defined terms at first introduction only.
- Every sentence ends with a period. Every sub-clause ends with a semicolon, comma, or period as grammatically appropriate.
- Sub-clause numbering: 1.1., 1.2.; within sub-clauses: (a), (b), (c).
- Length: 2500–3500 words.
- Output ONLY the agreement text. No commentary, no preamble, no notes.
- Start directly with the # title heading.`;
        }

        function buildPrompt2() {
            const v = id => document.getElementById(id).value;
            const confPeriod = v('confPeriod');
            const govLaw = getGoverningLaw() || '[governing law jurisdiction]';
            const isMutual = v('ndaType') === 'Mutual';

            // Build enhancement blocks conditionally
            let enhancements = [];
            let newSections = [];
            let n = 1;

            // ── 1. Residual Knowledge (always included) ──
            enhancements.push(`${n}. **Residual Knowledge** — integrate into Section 3 (Confidentiality Obligations) as a new sub-clause:
   ${v('residualKnowledge') === 'Restricted' ? 'RESTRICTED: The Receiving Party shall not use any residual knowledge (information retained in unaided memory without intentional memorisation) for competitive purposes, to develop competing products or services, or to the detriment of the Disclosing Party. This restriction applies even after termination of this Agreement for the duration of the confidentiality survival period.' : 'PERMITTED: Nothing in this Agreement shall prevent the Receiving Party from using general knowledge, skills, and experience retained in the unaided memory of its personnel in the ordinary course of business, provided that the Receiving Party shall not intentionally memorise Confidential Information for the purpose of circumventing this Agreement.'}`);
            n++;

            // ── 2. Return of Materials (always included) ──
            enhancements.push(`${n}. **Return of Materials** — strengthen Section 5:
   - Specify that all Confidential Information must be returned or destroyed within ${v('returnDays')} calendar days of the earlier of: (a) written request by the Disclosing Party; or (b) termination or expiry of this Agreement.
   - Written certification of destruction required: ${v('writtenCert')}.
   - Retain the exception for copies required by law or on routine backup systems (subject to ongoing confidentiality obligations).
   - Ensure the timeframe is consistent throughout (Section 5.1 must match this number exactly).`);
            n++;

            // ── 3. Restrict Professional Advisors (only if restricting) ──
            if (v('restrictAdvisors') === 'Yes') {
                enhancements.push(`${n}. **Professional Advisors — Restriction** — modify Section 4:
   The base NDA permits disclosure to professional advisors. REPLACE this with a restriction: disclosure of Confidential Information to the Receiving Party's external legal counsel, accountants, auditors, or financial advisors shall require the prior written consent of the Disclosing Party. Remove any existing sub-clause that permits disclosure to professional advisors without consent.`);
                n++;
            }

            // ── 4. Compelled Disclosure ──
            enhancements.push(`${n}. **Compelled Disclosure** — verify and strengthen Section 4.2:
   ${v('notifyCompelled') === 'Yes' ? 'Ensure Section 4.2 includes ALL of the following: (a) the Receiving Party must provide the Disclosing Party with prompt prior written notice of any compelled disclosure, UNLESS such notice is expressly prohibited by the relevant court order, governmental directive, or applicable law; (b) cooperation with the Disclosing Party in seeking a protective order or limiting the scope of disclosure; (c) disclosure of only the minimum portion legally required; and (d) commercially reasonable efforts to obtain confidential treatment for the disclosed information. If any of these elements are missing from the base NDA, add them.' : 'Simplify Section 4.2: Confidential Information may be disclosed to the extent strictly required by applicable law, regulation, or binding order of a court or governmental authority, without any prior notice obligation.'}`);
            n++;

            // ── 5. Prohibit Public LLM / AI Uploads ──
            if (v('prohibitLLM') === 'Yes') {
                enhancements.push(`${n}. **Prohibition on AI / LLM Processing** — add as a new sub-clause in Section 3 (Confidentiality Obligations):
   The Receiving Party shall not input, upload, submit, or otherwise process any Confidential Information through any publicly available artificial intelligence system, large language model, machine learning tool, or similar technology (including but not limited to ChatGPT, Claude, Gemini, Copilot, or any successor or equivalent service) where such input may be used for model training, stored beyond the session, or accessible to third parties. This prohibition extends to any AI-powered tool where the Receiving Party cannot guarantee that the Confidential Information will not be retained, processed, or exposed beyond the Receiving Party's direct control. Use of enterprise-deployed AI tools with contractual data protection guarantees equivalent to this Agreement may be permitted with the prior written consent of the Disclosing Party.`);
                n++;
            }

            // ── 6. Non-Solicitation (conditional) ──
            if (v('prohibitSoliciting') === 'Yes') {
                const scope = v('solicitScope');
                const duration = v('solicitDuration');
                const carveout = v('solicitCarveout');
                let scopeText = 'any employee or officer';
                if (scope === 'Employees+Contractors') scopeText = 'any employee, officer, contractor, or consultant';
                if (scope === 'All+Clients') scopeText = 'any employee, officer, contractor, consultant, client, or customer';

                enhancements.push(`${n}. **Non-Solicitation** — ADD as a new section (insert after Remedies, before Term and Termination):
   - For a period of ${duration} months from the Effective Date, neither Party shall directly or indirectly solicit, recruit, hire, induce, or attempt to solicit ${scopeText} of the other Party who has had access to Confidential Information under this Agreement, without the prior written consent of that Party.
   ${carveout === 'Yes' ? '- Carve-out: This restriction shall not apply to general advertisements or public job postings not specifically targeted at the other Party\'s personnel, provided that the advertising Party did not directly or indirectly encourage such personnel to respond to such advertisement.' : '- No carve-out: All forms of solicitation are prohibited, including responses to general advertisements where the soliciting Party had prior knowledge of the individual\'s engagement with the other Party.'}
   - Update the survival clause to include this new section.`);
                newSections.push('Non-Solicitation');
                n++;
            }

            // ── 7. Non-Compete (conditional) ──
            if (v('nonCompete') === 'Yes') {
                const compDuration = v('competeDuration');
                const compGeo = document.getElementById('competeGeo').value || '[geographic scope to be specified]';
                const compScope = document.getElementById('competeScope').value || '[industry/activity scope to be specified]';

                enhancements.push(`${n}. **Non-Compete** — ADD as a new section (insert after Non-Solicitation if present, otherwise after Remedies):
   - For a period of ${compDuration} months from the Effective Date, the Receiving Party shall not, directly or indirectly, engage in, own, manage, operate, control, be employed by, consult for, or otherwise participate in any business that competes with the Disclosing Party's business within the following scope:
   - Geographic scope: ${compGeo}.
   - Activity/industry scope: ${compScope}.
   - This restriction must be reasonable and proportionate. Include a severability sub-clause: if any court finds the scope, duration, or geographic restriction to be unreasonable, the court may modify (rather than void) the restriction to the minimum extent necessary to make it enforceable.
   ${isMutual ? '- In a mutual NDA, apply this restriction symmetrically to both Parties.' : '- This restriction applies to Party B (the Receiving Party) only.'}
   - IMPORTANT: Note in the clause that non-compete restrictions are unenforceable or severely limited in certain jurisdictions (e.g., California, Colorado, Minnesota in the USA; and may be limited in duration/scope under EU member state laws). The enforceability of this clause depends on the governing law of this Agreement.
   - Update the survival clause to include this new section.`);
                newSections.push('Non-Compete');
                n++;
            }

            // ── 8. Compensation for Breach ──
            const remedy = v('breachRemedy');
            const amount = document.getElementById('breachAmount').value;
            const currency = getBreachCurrency();
            if (remedy !== 'Damages') {
                enhancements.push(`${n}. **Compensation for Breach** — strengthen the Remedies section:
   ${remedy === 'Liquidated' ? `Add a liquidated damages clause: In addition to any other remedies available under this Agreement or applicable law, the Parties agree that in the event of a breach of the confidentiality obligations, the breaching Party shall pay to the non-breaching Party liquidated damages in the amount of ${currency} ${amount || '[amount to be specified]'} per breach, which the Parties acknowledge and agree represents a genuine pre-estimate of the loss that would be suffered and is not intended as a penalty.
   - IMPORTANT: This must be framed as a "genuine pre-estimate of loss" (not a penalty) to be enforceable in common law jurisdictions (UK, USA, Singapore, Hong Kong, Australia).` : `Add a contractual penalty clause: In addition to any other remedies available under this Agreement or applicable law, the breaching Party shall pay to the non-breaching Party a contractual penalty in the amount of ${currency} ${amount || '[amount to be specified]'} per breach.
   - Include a note: "The Parties acknowledge that this contractual penalty is enforceable under the governing law of this Agreement."
   - IMPORTANT WARNING: Contractual penalties are enforceable in civil law jurisdictions (EU member states, Latin America, UAE, CIS countries) but are generally UNENFORCEABLE in common law jurisdictions (UK, USA, Singapore, Hong Kong, Australia). If the governing law is a common law jurisdiction, reframe this as liquidated damages instead.`}
   - The remedies clause must state that liquidated damages/penalties are IN ADDITION TO (not in substitution for) injunctive relief, specific performance, and actual damages.`);
                n++;
            }

            // ── 9. Dispute Resolution (always included) ──
            const disputeBlock = v('disputeMethod') !== 'Courts' ? (() => {
                const key = v('arbRules');
                const inst = ARB_INSTITUTIONS[key];
                const seat = v('arbLocation') || (inst ? inst.defaultSeat : '[To be specified]');
                const lang = document.getElementById('arbLanguage').value || 'English';
                const clauseText = inst ? inst.modelClause(seat, lang, govLaw, v('arbCount') || '1') : '';
                return `Replace with arbitration:
   Institution: ${inst ? inst.name : key}
   Seat/Place: ${seat}
   Language: ${lang}

   Structure:
   First sub-clause: Good-faith negotiations for thirty (30) days.
   ${v('disputeMethod') === 'Mediation then Arbitration' ? 'Second sub-clause: If negotiations fail, mediation for a further thirty (30) days.\n   Third sub-clause:' : 'Second sub-clause:'} Arbitration — use this model clause (preserve ALL substantive terms verbatim, adapt only section numbering):
   "${clauseText}"
   Ensure the governing law reference within the arbitration clause matches the Governing Law section exactly.`;
            })() : `Keep courts-based resolution:
   First sub-clause: Good-faith negotiations for thirty (30) days from written notice of dispute.
   Second sub-clause: Courts of ${govLaw} shall have exclusive jurisdiction. Each Party irrevocably submits to such jurisdiction and waives any objection to venue.
   Ensure the jurisdiction matches the Governing Law section exactly.`;

            enhancements.push(`${n}. **Dispute Resolution** — rewrite the Dispute Resolution section:
   Method: ${v('disputeMethod')}
   ${disputeBlock}`);

            return `You are a senior international corporate lawyer. You are given an existing NDA and a list of enhancements. Produce a COMPLETE, enhanced version of the NDA integrating all specified enhancements while maintaining perfect internal consistency.

EXISTING NDA:
${generatedNDAText}

═══ ENHANCEMENTS ═══

${enhancements.join('\n\n')}

═══ MANDATORY RULES ═══

OUTPUT: The COMPLETE enhanced NDA from title to signature block. Every section of the original must be present. Do not omit anything.

INTERNAL CONSISTENCY:
- All defined terms must remain exactly as defined in the original NDA. Only introduce new defined terms if explicitly required by the enhancements above.
- ALL section cross-references must be numerically accurate. After inserting ${newSections.length > 0 ? 'new sections (' + newSections.join(', ') + ')' : 'any modifications'}, renumber ALL subsequent sections and update EVERY cross-reference in the entire document.
- The survival clause must list ALL surviving sections by their CORRECT final number — verify each one exists.
- Governing law must match between the Governing Law and Dispute Resolution sections.
- Confidentiality survival period must remain exactly ${confPeriod} year(s) everywhere it appears.
- ${isMutual ? 'MUTUAL NDA: Every obligation must apply symmetrically to both Parties.' : 'UNILATERAL NDA: Party A = Disclosing Party, Party B = Receiving Party throughout.'}

SECTION NUMBERING:
- Insert new sections in logical order: after current Remedies section, before Term and Termination.${newSections.length > 0 ? '\n- New sections to insert: ' + newSections.join(', ') + '.' : ''}
- Renumber ALL subsequent sections after any insertion.
- After renumbering, perform a FINAL PASS to verify every cross-reference points to the correct section number.

NO CONTRADICTIONS:
- The Remedies section must not limit remedies to ONLY damages if liquidated damages or penalties are added — state they are "in addition to" all other remedies.
- If non-compete is added, it must not contradict any residual knowledge clause.
- If professional advisor restriction is added, ensure Section 4 (Permitted Disclosure) does not simultaneously permit and restrict advisor disclosure.
- Compelled disclosure provisions must be consistent with the notice obligation setting.

FORMATTING:
- Bold defined terms at first use only.
- Numbering: ## 1., sub-clauses 1.1., lists (a), (b), (c).
- Every sentence ends with a period.
- Preserve the signature block table with all fields.
- No commentary, notes, or text outside the agreement.
- Start directly with the # title heading.
- Length: 3000–5000 words.`;
        }
        async function safeJson(res) {
            const text = await res.text();
            try { return JSON.parse(text); }
            catch (e) {
                if (text.trim().startsWith('<')) throw new Error('Server returned an error page — the function may have timed out. Please try again.');
                throw new Error('Invalid response from server');
            }
        }

        // Non-streaming fallback: calls the old generate-nda function
        async function fallbackGenerate(prompt, contentEl) {
            if (contentEl) contentEl.innerHTML = '<p style="color:var(--text-muted);font-style:italic;">Generating (non-streaming)...</p>';
            const res = await fetch('/.netlify/functions/generate-nda', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            const data = await safeJson(res);
            if (!res.ok) throw new Error(data.error || 'Generation failed');
            return data.result;
        }

        // Streaming: calls V2 function, renders text in real-time, returns full text
        async function streamGenerate(prompt, contentEl, resultEl, loadingEl) {
            if (resultEl) resultEl.classList.remove('hidden');
            if (contentEl) contentEl.innerHTML = '<p style="color:var(--text-muted);font-style:italic;">Generating...</p>';

            let res;
            try {
                res = await fetch('/api/generate-nda-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
            } catch (fetchErr) {
                // Network error — fall back
                console.warn('Streaming fetch failed, falling back:', fetchErr);
                const result = await fallbackGenerate(prompt, contentEl);
                if (contentEl) contentEl.innerHTML = formatNDA(result);
                if (loadingEl) loadingEl.classList.add('hidden');
                return result;
            }

            // If response is JSON (error response) or HTML (Netlify error page)
            const ct = res.headers.get('content-type') || '';

            if (ct.includes('application/json')) {
                // JSON error from our function
                let data;
                try { data = await res.json(); } catch(e) { data = {}; }
                throw new Error(data.error || 'Generation failed');
            }

            if (!ct.includes('text/event-stream')) {
                // Not SSE — probably HTML error page or 404. Fall back to regular function.
                console.warn('Streaming endpoint returned non-SSE (' + ct + '), status:', res.status, '— falling back');
                const result = await fallbackGenerate(prompt, contentEl);
                if (contentEl) contentEl.innerHTML = formatNDA(result);
                if (loadingEl) loadingEl.classList.add('hidden');
                return result;
            }

            if (!res.ok) {
                console.warn('Streaming endpoint failed with status', res.status, '— falling back');
                const result = await fallbackGenerate(prompt, contentEl);
                if (contentEl) contentEl.innerHTML = formatNDA(result);
                if (loadingEl) loadingEl.classList.add('hidden');
                return result;
            }

            // Read SSE stream
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            let buffer = '';
            let renderTimer = null;

            function scheduleRender() {
                if (renderTimer) return;
                renderTimer = setTimeout(() => {
                    renderTimer = null;
                    if (contentEl) contentEl.innerHTML = formatNDA(fullText + '▊');
                }, 100);
            }

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const data = line.slice(6).trim();
                        if (data === '[DONE]') continue;

                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.error) throw new Error(parsed.error);
                            if (parsed.text) {
                                fullText += parsed.text;
                                scheduleRender();
                            }
                        } catch (e) {
                            if (e.message && !e.message.includes('JSON')) throw e;
                        }
                    }
                }
            } catch (streamErr) {
                console.error('Stream read error:', streamErr);
                // If we got some text, use it; otherwise re-throw
                if (!fullText) throw streamErr;
            }

            // Final render without cursor
            if (renderTimer) clearTimeout(renderTimer);
            if (contentEl) contentEl.innerHTML = formatNDA(fullText);
            if (loadingEl) loadingEl.classList.add('hidden');
            if (!fullText) throw new Error('No text was generated. Please try again.');
            return fullText;
        }

        async function generateNDA() {
            const prompt = buildPrompt1();
            document.getElementById('generateBtn1').disabled = true;
            document.getElementById('loadingState1').classList.remove('hidden');
            document.getElementById('result1').classList.add('hidden');

            try {
                const contentEl = document.getElementById('ndaContent1');
                const resultEl = document.getElementById('result1');
                const loadingEl = document.getElementById('loadingState1');

                generatedNDAText = await streamGenerate(prompt, contentEl, resultEl, loadingEl);
                document.getElementById('footerCTA').classList.remove('hidden');
                updateBadge(1);

                savePartyData('A');
                savePartyData('B');
                saveToHistory('A', document.getElementById('partyAName').value, document.getElementById('partyAAddress').value, document.getElementById('partyAEmail').value, document.getElementById('partyAType').value, document.getElementById('partyACompanyNumber').value, document.getElementById('partyASignatory').value, document.getElementById('partyATitle').value);
                saveToHistory('B', document.getElementById('partyBName').value, document.getElementById('partyBAddress').value, document.getElementById('partyBEmail').value, document.getElementById('partyBType').value, document.getElementById('partyBCompanyNumber').value, document.getElementById('partyBSignatory').value, document.getElementById('partyBTitle').value);
            } catch (e) { alert('Error: ' + e.message); }
            finally {
                document.getElementById('loadingState1').classList.add('hidden');
                document.getElementById('generateBtn1').disabled = false;
            }
        }

        async function generateEnhancedNDA() {
            const prompt = buildPrompt2();
            document.getElementById('generateBtn2').disabled = true;
            document.getElementById('loadingState2').classList.remove('hidden');
            document.getElementById('result2').classList.add('hidden');

            try {
                const contentEl = document.getElementById('ndaContent2');
                const resultEl = document.getElementById('result2');
                const loadingEl = document.getElementById('loadingState2');

                generatedNDAText2 = await streamGenerate(prompt, contentEl, resultEl, loadingEl);
                updateBadge(2);
            } catch (e) { alert('Error: ' + e.message); }
            finally {
                document.getElementById('loadingState2').classList.add('hidden');
                document.getElementById('generateBtn2').disabled = false;
            }
        }

        async function generateSummary() {
            const nda = generatedNDAText2 || generatedNDAText;
            const prompt = `You are a friendly legal communicator. Create a clear, professional plain-English summary of this NDA for the receiving party.

${nda}

REQUIREMENTS:
- Use a friendly but professional tone
- Structure with clear headings: "What is this agreement?", "What you're agreeing to", "What counts as confidential", "How long it lasts", "Your rights", "Key obligations"
- Explain each section simply without legal jargon
- Mention any specific protections or obligations (non-solicitation, return of materials, etc.)
- End with: "**This summary is provided for convenience only and does not constitute legal advice. The NDA itself is the binding document.**"
- Use markdown formatting for readability`;

            document.getElementById('generateBtn3').disabled = true;
            document.getElementById('loadingState3').classList.remove('hidden');
            document.getElementById('result3').classList.add('hidden');

            try {
                const contentEl = document.getElementById('summaryContent');
                const resultEl = document.getElementById('result3');
                const loadingEl = document.getElementById('loadingState3');

                generatedSummaryText = await streamGenerate(prompt, contentEl, resultEl, loadingEl);
                updateBadge(3);
            } catch (e) { alert('Error: ' + e.message); }
            finally {
                document.getElementById('loadingState3').classList.add('hidden');
                document.getElementById('generateBtn3').disabled = false;
            }
        }

        function formatNDA(text) {
            marked.setOptions({ breaks: true, gfm: true });
            return marked.parse(text);
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Brief visual feedback
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1500);
            });
        }

        function downloadPDF(elementId, filename) {
            const element = document.getElementById(elementId);
            // Temporarily remove scroll constraints so html2pdf captures full content
            const origMaxH = element.style.maxHeight;
            const origOverflow = element.style.overflow;
            element.style.maxHeight = 'none';
            element.style.overflow = 'visible';

            const opt = {
                margin: [20, 18, 20, 18],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                // Restore scroll constraints
                element.style.maxHeight = origMaxH;
                element.style.overflow = origOverflow;
            }).catch(() => {
                element.style.maxHeight = origMaxH;
                element.style.overflow = origOverflow;
            });
        }

        // ═══════ Init ═══════
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('agreementDate').value = new Date().toISOString().split('T')[0];

            // Clear all party fields to prevent browser autofill persistence
            ['A', 'B'].forEach(party => {
                ['Name', 'CompanyNumber', 'Address', 'Email', 'Signatory', 'Title'].forEach(field => {
                    const el = document.getElementById(`party${party}${field}`);
                    if (el) el.value = '';
                });
                const typeEl = document.getElementById(`party${party}Type`);
                if (typeEl) typeEl.value = 'Company';
            });
            const searchA = document.getElementById('searchA');
            const searchB = document.getElementById('searchB');
            if (searchA) searchA.value = '';
            if (searchB) searchB.value = '';

            populateHistoryDropdowns();
            updateGoverningLawOptions();
            document.getElementById('partyAAddress').addEventListener('input', updateGoverningLawOptions);
            document.getElementById('partyBAddress').addEventListener('input', updateGoverningLawOptions);

            // Close dropdowns on outside click
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-wrap')) {
                    document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.classList.add('hidden'));
                }
            });
        });
    </script>
</body>
</html>
